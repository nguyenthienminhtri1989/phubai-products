--- PROJECT SOURCE CODE ---



================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\package.json
================================================================================
{
  "name": "phubai-products",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@ant-design/icons": "^6.1.0",
    "@ant-design/nextjs-registry": "^1.3.0",
    "@prisma/adapter-pg": "^7.2.0",
    "antd": "^6.1.3",
    "bcryptjs": "^3.0.3",
    "dotenv": "^17.2.3",
    "next": "16.1.1",
    "next-auth": "^5.0.0-beta.30",
    "pg": "^8.16.3",
    "react": "19.2.3",
    "react-dom": "19.2.3",
    "recharts": "^3.7.0",
    "xlsx": "^0.18.5"
  },
  "devDependencies": {
    "@prisma/client": "^5.22.0",
    "@tailwindcss/postcss": "^4",
    "@types/bcryptjs": "^2.4.6",
    "@types/node": "^20.19.27",
    "@types/pg": "^8.16.0",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "16.1.1",
    "prisma": "^5.22.0",
    "tailwindcss": "^4",
    "ts-node": "^10.9.2",
    "typescript": "^5"
  },
  "prisma": {
    "seed": "ts-node --compiler-options {\"module\":\"CommonJS\"} prisma/seed.ts"
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\package.json ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\prisma\schema.prisma
================================================================================
// File: schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // Ho·∫∑c "mysql", "sqlserver" t√πy b·∫°n ch·ªçn
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. QU·∫¢N L√ù C·∫§U TR√öC NH√Ä M√ÅY (Hierarchy)
// ==========================================

model Factory {
  id        Int       @id @default(autoincrement())
  name      String    // T√™n nh√† m√°y (NM1, NM2...)
  note      String?   // Ghi ch√∫

  processes Process[] // 1 Nh√† m√°y c√≥ nhi·ªÅu C√¥ng ƒëo·∫°n

  @@map("factories")
}

// ==========================================
// 2. C√îNG ƒêO·∫†N
// ==========================================
model Process {
  id        Int       @id @default(autoincrement())
  name      String    // T√™n c√¥ng ƒëo·∫°n (b√¥ng ch·∫£i, gh√©p th√¥...)
  
  factoryId Int
  factory   Factory   @relation(fields: [factoryId], references: [id])

  machines  Machine[] // 1 C√¥ng ƒëo·∫°n qu·∫£n l√Ω nhi·ªÅu M√°y
  users     User[]    // Ph√¢n quy·ªÅn: User n√†o thu·ªôc c√¥ng ƒëo·∫°n n√†o

  @@map("processes")
}

// ==========================================
// 2. DANH M·ª§C M·∫∂T H√ÄNG (Items)
// ==========================================

model Item {
  id           Int     @id @default(autoincrement())
  
  // C√°c tr∆∞·ªùng th√¥ng tin c∆° b·∫£n
  name         String  @unique // T√™n ƒë·∫ßy ƒë·ªß (Kh√¥ng ƒë∆∞·ª£c tr√πng)
  code         String? // M√£ vi·∫øt t·∫Øt (n·∫øu c·∫ßn sau n√†y, t·∫°m ƒë·ªÉ optional)
  
  // C√°c th√¥ng s·ªë k·ªπ thu·∫≠t (Optional - Kh√¥ng b·∫Øt bu·ªôc)
  ne           Int?    // Chi s·ªë (S·ªë nguy√™n 3 ch·ªØ s·ªë)
  composition  String? // Th√†nh ph·∫ßn
  twist        Int?    // ƒê·ªô sƒÉn (S·ªë nguy√™n)
  weavingStyle String? // Ki·ªÉu d·ªát
  material     String? // Nguy√™n li·ªáu
  
  // Quan h·ªá (Gi·ªØ nguy√™n logic c≈©)
  runningOnMachines Machine[]       // ƒêang ch·∫°y tr√™n m√°y n√†o?
  productionLogs    ProductionLog[] // L·ªãch s·ª≠ s·∫£n xu·∫•t

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("items")
}

// ==========================================
// 3. DANH M·ª§C M√ÅY M√ìC (Machines) - C·∫•u h√¨nh
// ==========================================

model Machine {
  id          Int      @id @default(autoincrement())
  name        String   @unique // T√™n m√°y (M√°y 01, M√°y 02...)
  isActive    Boolean  @default(true) // True: ƒêang d√πng, False: ƒê√£ thanh l√Ω (Thay m√°y m·ªõi)

  // --- Ph√¢n c·∫•p ---
  processId   Int
  process     Process  @relation(fields: [processId], references: [id])

  // --- C·∫•u h√¨nh t√≠nh to√°n (Quan tr·ªçng) ---
  // 1: Nh·∫≠p th·∫≥ng kg
  // 2: (Cu·ªëi - ƒê·∫ßu)
  // 3: (Cu·ªëi - ƒê·∫ßu) * S·ªë c·ªçc / (Chi s·ªë * K)
  // 4: (Cu·ªëi - ƒê·∫ßu) / Chi s·ªë
  formulaType Int      @default(1) 

  spindleCount Int?    // S·ªë c·ªçc (Ch·ªâ d√πng cho FormulaType = 3, m√°y kh√°c ƒë·ªÉ Null)

  // --- Tr·∫°ng th√°i hi·ªán t·∫°i ---
  currentItemId Int?   // M√°y ƒëang ch·∫°y h√†ng n√†o? (D√πng ƒë·ªÉ g·ª£i √Ω khi nh·∫≠p li·ªáu)
  currentItem   Item?  @relation(fields: [currentItemId], references: [id])

  // 2. Chi s·ªë ƒëang ch·∫°y l√† bao nhi√™u?
  // D√†nh cho m√°y lo·∫°i 3, 4. 
  // Gi√° tr·ªã n√†y s·∫Ω t·ª± ƒë·ªông nh·∫£y v√†o √¥ nh·∫≠p li·ªáu ƒë·ªÉ c√¥ng nh√¢n ƒë·ª° ph·∫£i g√µ.
  currentNE     Float?

  // --- D·ªØ li·ªáu l·ªãch s·ª≠ ---
  productionLogs ProductionLog[]

  @@map("machines")
}

// ==========================================
// 4. NH·∫¨T K√ù S·∫¢N L∆Ø·ª¢NG (D·ªØ li·ªáu h√†ng ng√†y)
// ==========================================

model ProductionLog {
  id          Int      @id @default(autoincrement())
  
  // 1. Th√¥ng tin M√°y & Th·ªùi gian
  machineId   Int
  recordDate  DateTime @db.Date // Ch·ªâ l∆∞u ng√†y
  shift       Int      // 1, 2, 3
  
  // 2. Th√¥ng tin M·∫∑t h√†ng (S·ª≠a l·ªói quan h·ªá v·ªõi Item)
  itemId      Int
  item        Item     @relation(fields: [itemId], references: [id]) 
  
  // 3. Ch·ªâ s·ªë & S·∫£n l∆∞·ª£ng
  startIndex  Float?   @default(0) // <--- C·ªôt m·ªõi th√™m
  endIndex    Float?
  inputNE     Float?   
  finalOutput Float    
  
  note        String?

  // 4. Quan h·ªá v·ªõi User (S·ª≠a l·ªói createdLogs trong User)
  // Th√™m d√≤ng n√†y ƒë·ªÉ Prisma bi·∫øt ai l√† ng∆∞·ªùi t·∫°o b·∫£n ghi
  createdById Int?     // C√≥ th·ªÉ ƒë·ªÉ null n·∫øu ch∆∞a b·∫Øt bu·ªôc
  createdBy   User?    @relation(fields: [createdById], references: [id])
  
  // 5. Quan h·ªá v·ªõi M√°y
  machine     Machine  @relation(fields: [machineId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // TH√äM ƒêO·∫†N N√ÄY V√ÄO CU·ªêI MODEL:
  // 1. Index cho vi·ªác l·ªçc theo kho·∫£ng th·ªùi gian (quan tr·ªçng nh·∫•t)
  @@index([recordDate])
  
  // 2. Index composite: Khi l·ªçc k·∫øt h·ª£p Ng√†y + M√°y + Ca (Performance c·ª±c cao)
  @@index([recordDate, machineId])
  @@index([machineId, shift])
  @@index([itemId])

  // R√†ng bu·ªôc duy nh·∫•t: 1 M√°y + 1 Ng√†y + 1 Ca ch·ªâ c√≥ 1 b·∫£n ghi
  @@unique([machineId, recordDate, shift])
  @@map("production_logs")
}

// ==========================================
// 5. NG∆Ø·ªúI D√ôNG (Qu·∫£n l√Ω quy·ªÅn h·∫°n)
// ==========================================

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String   // L∆∞u hash (ƒë√£ m√£ h√≥a)
  fullName  String
  
  // --- PH√ÇN QUY·ªÄN ---
  role        String   @default("USER") // "ADMIN" ho·∫∑c "USER"
  accessLevel String   @default("READ_ONLY") // "READ_ONLY", "OPERATOR", "MANAGER"
  
  // --- TR·∫†NG TH√ÅI ---
  isActive    Boolean  @default(false)  // false: Ch·ªù duy·ªát, true: ƒê∆∞·ª£c d√πng

  // --- PH·∫†M VI C√îNG VI·ªÜC ---
  processId   Int?     // User thu·ªôc c√¥ng ƒëo·∫°n n√†o?
  process     Process? @relation(fields: [processId], references: [id])

  createdLogs ProductionLog[] // Quan h·ªá: Ai nh·∫≠p d√≤ng n√†y?
  createdAt   DateTime @default(now())

  @@map("users")
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\prisma\schema.prisma ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\prisma\seed.ts
================================================================================
import { PrismaClient } from "@prisma/client";
import * as bcrypt from "bcryptjs";

const prisma = new PrismaClient();

async function main() {
  console.log("üå± ƒêang kh·ªüi t·∫°o d·ªØ li·ªáu m·∫´u...");

  // 1. T·∫†O NH√Ä M√ÅY
  const factory1 = await prisma.factory.create({
    data: { name: "Nh√† m√°y S·ª£i 1" },
  });
  const factory2 = await prisma.factory.create({
    data: { name: "Nh√† m√°y S·ª£i 2" },
  });
  const factory3 = await prisma.factory.create({
    data: { name: "Nh√† m√°y S·ª£i 3" },
  });

  // 2. T·∫†O C√îNG ƒêO·∫†N
  // Nh√† m√°y 1
  const procBongChai1 = await prisma.process.create({
    data: { name: "B√¥ng Ch·∫£i NM12", factoryId: factory1.id },
  });
  const proGhepTho1 = await prisma.process.create({
    data: { name: "Gh√©p Th√¥ NM1", factoryId: factory1.id },
  });
  const proSoiCon1 = await prisma.process.create({
    data: { name: "S·ª£i con NM1", factoryId: factory1.id },
  });
  const proDanhOng1 = await prisma.process.create({
    data: { name: "ƒê√°nh ·ªëng NM1", factoryId: factory1.id },
  });
  const proDauXe = await prisma.process.create({
    data: { name: "ƒê·∫≠u Xe", factoryId: factory1.id },
  });
  // Nh√† m√°y 2
  const proGhepTho2 = await prisma.process.create({
    data: { name: "Gh√©p Th√¥ NM2", factoryId: factory2.id },
  });
  const proSoiCon2 = await prisma.process.create({
    data: { name: "S·ª£i con NM2", factoryId: factory2.id },
  });
  const proDanhOng2 = await prisma.process.create({
    data: { name: "ƒê√°nh ·ªëng NM2", factoryId: factory2.id },
  });
  const proChaiKy2 = await prisma.process.create({
    data: { name: "Cu·ªôn c√∫i - Ch·∫£i k·ªπ NM2", factoryId: factory2.id },
  });
  // Nh√† m√°y 3
  const procBongChai3 = await prisma.process.create({
    data: { name: "B√¥ng Ch·∫£i NM3", factoryId: factory3.id },
  });
  const proGhepTho3 = await prisma.process.create({
    data: { name: "Gh√©p Th√¥ NM3", factoryId: factory3.id },
  });
  const proSoiCon3 = await prisma.process.create({
    data: { name: "S·ª£i con NM3", factoryId: factory3.id },
  });
  const proDanhOng3 = await prisma.process.create({
    data: { name: "ƒê√°nh ·ªëng NM3", factoryId: factory3.id },
  });
  const proChaiKy3 = await prisma.process.create({
    data: { name: "Cu·ªôn c√∫i - Ch·∫£i k·ªπ NM3", factoryId: factory3.id },
  });

  // // 3. T·∫†O M·∫∂T H√ÄNG (ITEMS)
  // const itemCVC = await prisma.item.create({
  //   data: { name: 'CVC 30', code: 'CVC30', ne: 30 },
  // })
  // const itemTC = await prisma.item.create({
  //   data: { name: 'TC 40', code: 'TC40', ne: 40 },
  // })

  // // 4. T·∫†O M√ÅY M√ìC (MACHINES)
  // // M√°y Th√¥ (Lo·∫°i 1 - S·∫£n l∆∞·ª£ng tr·ª±c ti·∫øp)
  // await prisma.machine.create({
  //   data: {
  //     name: 'M√°y Th√¥ 01',
  //     processId: proctho.id,
  //     formulaType: 1,
  //     isActive: true,
  //     currentNE: 0,
  //     currentItemId: itemCVC.id // G√°n lu√¥n m·∫∑t h√†ng ƒëang ch·∫°y
  //   },
  // })

  // // M√°y ·ªêng (Lo·∫°i 2 - Tr·ª´ l√πi)
  // await prisma.machine.create({
  //   data: {
  //     name: 'M√°y ·ªêng 01',
  //     processId: procOng.id,
  //     formulaType: 2,
  //     isActive: true,
  //     currentNE: 30,
  //     currentItemId: itemCVC.id
  //   },
  // })

  // // M√°y S·ª£i Con (Lo·∫°i 3 - C√¥ng th·ª©c ph·ª©c t·∫°p)
  // await prisma.machine.create({
  //   data: {
  //     name: 'M√°y S·ª£i 01',
  //     processId: procSoiCon.id,
  //     formulaType: 3,
  //     isActive: true,
  //     spindleCount: 480, // 480 c·ªçc
  //     currentNE: 30,
  //     currentItemId: itemCVC.id
  //   },
  // })

  // 5. T·∫†O T√ÄI KHO·∫¢N ADMIN (Quan tr·ªçng nh·∫•t)
  const hashedPassword = await bcrypt.hash("150489", 10);

  await prisma.user.create({
    data: {
      username: "admin",
      password: hashedPassword,
      fullName: "Qu·∫£n tr·ªã vi√™n",
      role: "ADMIN",
      accessLevel: "MANAGER",
      isActive: true, // K√≠ch ho·∫°t lu√¥n
    },
  });

  console.log("‚úÖ ƒê√£ t·∫°o xong d·ªØ li·ªáu m·∫´u!");
}

main()
  .then(async () => {
    await prisma.$disconnect();
  })
  .catch(async (e) => {
    console.error(e);
    await prisma.$disconnect();
    process.exit(1);
  });


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\prisma\seed.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\prisma.config.ts
================================================================================
// This file was generated by Prisma, and assumes you have installed the following:
// npm install --save-dev prisma dotenv
import "dotenv/config";
import { defineConfig } from "prisma/config";

export default defineConfig({
  schema: "prisma/schema.prisma",
  migrations: {
    path: "prisma/migrations",
  },
  datasource: {
    url: process.env["DATABASE_URL"],
  },
});


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\prisma.config.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\admin\backup\page.tsx
================================================================================
"use client";

import React, { useState } from "react";
import { Card, Button, Upload, message, Modal, Alert, Typography, Divider, Steps } from "antd";
import { CloudDownloadOutlined, CloudUploadOutlined, InboxOutlined, WarningOutlined } from "@ant-design/icons";
import { useSession } from "next-auth/react";

const { Title, Text } = Typography;
const { Dragger } = Upload;

export default function BackupPage() {
    const { data: session } = useSession();
    const [loading, setLoading] = useState(false);

    // --- X·ª¨ L√ù BACKUP (T·∫¢I V·ªÄ) ---
    const handleBackup = async () => {
        setLoading(true);
        try {
            const res = await fetch("/api/admin/backup");
            const data = await res.json();

            if (!res.ok) throw new Error(data.error);

            // T·∫°o file JSON ·∫£o ƒë·ªÉ t·∫£i v·ªÅ
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            // ƒê·∫∑t t√™n file theo ng√†y gi·ªù: backup-2026-02-05.json
            a.download = `backup-phubai-${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            window.URL.revokeObjectURL(url);

            message.success("ƒê√£ t·∫£i xu·ªëng file Backup th√†nh c√¥ng!");
        } catch (error) {
            console.error(error);
            message.error("L·ªói khi t·∫°o backup");
        } finally {
            setLoading(false);
        }
    };

    // --- X·ª¨ L√ù RESTORE (UPLOAD) ---
    const handleRestore = (file: File) => {
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const jsonContent = JSON.parse(e.target?.result as string);

                Modal.confirm({
                    title: "C·∫¢NH B√ÅO QUAN TR·ªåNG",
                    icon: <WarningOutlined style={{ color: "red" }} />,
                    content: (
                        <div>
                            <p>H√†nh ƒë·ªông n√†y s·∫Ω <b>X√ìA TO√ÄN B·ªò D·ªÆ LI·ªÜU HI·ªÜN T·∫†I</b> v√† thay th·∫ø b·∫±ng d·ªØ li·ªáu trong file backup.</p>
                            <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c kh√¥ng?</p>
                        </div>
                    ),
                    okText: "T√¥i ƒë·ªìng √Ω Kh√¥i ph·ª•c",
                    okType: "danger",
                    cancelText: "H·ªßy",
                    onOk: async () => {
                        setLoading(true);
                        try {
                            const res = await fetch("/api/admin/backup", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify(jsonContent),
                            });

                            if (!res.ok) throw new Error("L·ªói server");

                            message.success("Kh√¥i ph·ª•c d·ªØ li·ªáu th√†nh c√¥ng!");
                            // T√πy ch·ªçn: Reload trang
                            window.location.reload();
                        } catch (err) {
                            console.error(err);
                            message.error("File l·ªói ho·∫∑c c·∫•u tr√∫c kh√¥ng h·ª£p l·ªá");
                        } finally {
                            setLoading(false);
                        }
                    }
                });

            } catch (err) {
                console.error(err);
                message.error("File kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng JSON");
            }
        };
        reader.readAsText(file);
        return false; // Ch·∫∑n upload m·∫∑c ƒë·ªãnh c·ªßa Antd
    };

    if (session?.user?.role !== "ADMIN") return <div className="p-10 text-center">B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y</div>;

    return (
        <div className="p-6 max-w-4xl mx-auto">
            <Title level={2}>Sao l∆∞u & Ph·ª•c h·ªìi D·ªØ li·ªáu</Title>
            <Alert
                message="V√πng nguy hi·ªÉm"
                description="Ch·ª©c nƒÉng n√†y can thi·ªáp tr·ª±c ti·∫øp v√†o Database. H√£y c·∫©n th·∫≠n khi th·ª±c hi·ªán Ph·ª•c h·ªìi (Restore)."
                type="warning"
                showIcon
                style={{ marginBottom: 24 }}
            />

            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                {/* C·ªòT BACKUP */}
                <Card
                    title={<><CloudDownloadOutlined /> Sao l∆∞u (Export)</>}
                    bordered={false}
                    style={{ boxShadow: "0 4px 12px rgba(0,0,0,0.1)" }}
                >
                    <p>T·∫£i xu·ªëng to√†n b·ªô d·ªØ li·ªáu hi·ªán t·∫°i (M√°y m√≥c, M·∫∑t h√†ng, Nh·∫≠t k√Ω s·∫£n xu·∫•t, T√†i kho·∫£n...) d∆∞·ªõi d·∫°ng file <b>.json</b>.</p>
                    <p className="text-gray-500 text-sm mb-4">D√πng file n√†y ƒë·ªÉ l∆∞u tr·ªØ d·ª± ph√≤ng ho·∫∑c chuy·ªÉn d·ªØ li·ªáu sang m√°y kh√°c.</p>

                    <Button
                        type="primary"
                        size="large"
                        icon={<CloudDownloadOutlined />}
                        onClick={handleBackup}
                        loading={loading}
                        block
                    >
                        T·∫£i xu·ªëng File Backup
                    </Button>
                </Card>

                {/* C·ªòT RESTORE */}
                <Card
                    title={<><CloudUploadOutlined /> Ph·ª•c h·ªìi (Import)</>}
                    bordered={false}
                    style={{ boxShadow: "0 4px 12px rgba(0,0,0,0.1)" }}
                >
                    <p>Kh√¥i ph·ª•c d·ªØ li·ªáu t·ª´ file <b>.json</b> ƒë√£ backup tr∆∞·ªõc ƒë√≥.</p>
                    <p className="text-red-500 text-sm mb-4 font-bold">L∆∞u √Ω: D·ªØ li·ªáu hi·ªán t·∫°i s·∫Ω b·ªã ghi ƒë√® ho√†n to√†n.</p>

                    <Dragger
                        name="file"
                        multiple={false}
                        showUploadList={false}
                        beforeUpload={handleRestore}
                        disabled={loading}
                    >
                        <p className="ant-upload-drag-icon">
                            <InboxOutlined />
                        </p>
                        <p className="ant-upload-text">K√©o th·∫£ file JSON v√†o ƒë√¢y</p>
                        <p className="ant-upload-hint">
                            Ho·∫∑c b·∫•m ƒë·ªÉ ch·ªçn file t·ª´ m√°y t√≠nh
                        </p>
                    </Dragger>
                </Card>
            </div>

            <Divider />

            <div className="text-gray-500 text-sm">
                <b>Quy tr√¨nh khuy·∫øn ngh·ªã khi c·∫≠p nh·∫≠t ph·∫ßn m·ªÅm:</b>
                <Steps
                    size="small"
                    current={-1}
                    style={{ marginTop: 10 }}
                    items={[
                        { title: 'B·∫•m T·∫£i xu·ªëng Backup' },
                        { title: 'Th·ª±c hi·ªán c·∫≠p nh·∫≠t Code/DB' },
                        { title: 'N·∫øu m·∫•t d·ªØ li·ªáu -> Upload file ƒë·ªÉ Restore' },
                    ]}
                />
            </div>
        </div>
    );
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\admin\backup\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\admin\backup\route.ts
================================================================================
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { auth } from "@/auth";

// 1. BACKUP: T·∫£i d·ªØ li·ªáu v·ªÅ
export async function GET() {
  try {
    const session = await auth();
    if (session?.user?.role !== "ADMIN")
      return NextResponse.json(
        { error: "Ch·ªâ Admin m·ªõi ƒë∆∞·ª£c backup" },
        { status: 403 },
      );

    // L·∫•y song song d·ªØ li·ªáu t·ª´ c√°c b·∫£ng
    const [factories, processes, items, machines, users, productionLogs] =
      await Promise.all([
        prisma.factory.findMany(),
        prisma.process.findMany(),
        prisma.item.findMany(),
        prisma.machine.findMany(),
        prisma.user.findMany(),
        prisma.productionLog.findMany(),
      ]);

    // Gom l·∫°i th√†nh 1 object JSON
    const backupData = {
      timestamp: new Date().toISOString(),
      version: "1.0",
      data: {
        factories,
        processes,
        items,
        machines,
        users,
        productionLogs,
      },
    };

    return NextResponse.json(backupData);
  } catch (error) {
    console.error(error);
    return NextResponse.json({ error: "L·ªói khi t·∫°o backup" }, { status: 500 });
  }
}

// 2. RESTORE: Kh√¥i ph·ª•c d·ªØ li·ªáu t·ª´ file
export async function POST(req: Request) {
  try {
    const session = await auth();
    if (session?.user?.role !== "ADMIN")
      return NextResponse.json(
        { error: "Ch·ªâ Admin m·ªõi ƒë∆∞·ª£c restore" },
        { status: 403 },
      );

    const body = await req.json();
    const { factories, processes, items, machines, users, productionLogs } =
      body.data;

    // S·ª≠ d·ª•ng transaction ƒë·ªÉ ƒë·∫£m b·∫£o to√†n v·∫πn d·ªØ li·ªáu (Th·∫•t b·∫°i l√† rollback h·∫øt)
    await prisma.$transaction(async (tx) => {
      // B∆Ø·ªöC 1: D·ªçn d·∫πp d·ªØ li·ªáu c≈© (T√πy ch·ªçn: X√≥a h·∫øt ƒë·ªÉ n·∫°p l·∫°i cho s·∫°ch)
      // Ph·∫£i x√≥a theo th·ª© t·ª± ng∆∞·ª£c l·∫°i c·ªßa l√∫c t·∫°o ƒë·ªÉ tr√°nh l·ªói kh√≥a ngo·∫°i
      await tx.productionLog.deleteMany();
      await tx.machine.deleteMany();
      await tx.user.deleteMany();
      await tx.process.deleteMany();
      await tx.item.deleteMany();
      await tx.factory.deleteMany();

      // B∆Ø·ªöC 2: N·∫°p d·ªØ li·ªáu m·ªõi (Theo ƒë√∫ng th·ª© t·ª± ph·ª• thu·ªôc)

      // 2.1. Nh√† m√°y
      if (factories?.length > 0)
        await tx.factory.createMany({ data: factories });

      // 2.2. M·∫∑t h√†ng & C√¥ng ƒëo·∫°n
      if (items?.length > 0) await tx.item.createMany({ data: items });
      if (processes?.length > 0)
        await tx.process.createMany({ data: processes });

      // 2.3. User (C·∫ßn C√¥ng ƒëo·∫°n)
      if (users?.length > 0) await tx.user.createMany({ data: users });

      // 2.4. M√°y m√≥c (C·∫ßn C√¥ng ƒëo·∫°n & M·∫∑t h√†ng)
      if (machines?.length > 0) await tx.machine.createMany({ data: machines });

      // 2.5. Nh·∫≠t k√Ω (C·∫ßn M√°y, User, Item)
      // L∆∞u √Ω: Nh·∫≠t k√Ω c√≥ th·ªÉ r·∫•t nhi·ªÅu, n·∫øu > 5000 b·∫£n ghi c√≥ th·ªÉ c·∫ßn chia nh·ªè (batching).
      // ·ªû ƒë√¢y ta gi·∫£ ƒë·ªãnh d·ªØ li·ªáu ch∆∞a qu√° l·ªõn.
      if (productionLogs?.length > 0) {
        // Format l·∫°i Date string v·ªÅ Date object
        const formattedLogs = productionLogs.map((log: any) => ({
          ...log,
          recordDate: new Date(log.recordDate),
          createdAt: new Date(log.createdAt),
          updatedAt: new Date(log.updatedAt),
        }));
        await tx.productionLog.createMany({ data: formattedLogs });
      }
    });

    return NextResponse.json({ message: "Kh√¥i ph·ª•c d·ªØ li·ªáu th√†nh c√¥ng!" });
  } catch (error) {
    console.error("Restore Error:", error);
    return NextResponse.json(
      { error: "L·ªói kh√¥i ph·ª•c d·ªØ li·ªáu (C√≥ th·ªÉ do sai c·∫•u tr√∫c file)" },
      { status: 500 },
    );
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\admin\backup\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\auth\register\route.ts
================================================================================
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import * as bcrypt from "bcryptjs";

export async function POST(req: Request) {
  try {
    const body = await req.json();
    const { username, password, fullName, processId } = body;

    // 1. Ki·ªÉm tra d·ªØ li·ªáu ƒë·∫ßu v√†o
    if (!username || !password || !fullName || !processId) {
      return NextResponse.json(
        {
          error:
            "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin: T√™n ƒëƒÉng nh·∫≠p, M·∫≠t kh·∫©u, H·ªç t√™n v√† B·ªô ph·∫≠n",
        },
        { status: 400 },
      );
    }

    // 2. Ki·ªÉm tra xem username ƒë√£ t·ªìn t·∫°i ch∆∞a
    const existingUser = await prisma.user.findUnique({
      where: { username },
    });

    if (existingUser) {
      return NextResponse.json(
        {
          error:
            "T√™n ƒëƒÉng nh·∫≠p n√†y ƒë√£ c√≥ ng∆∞·ªùi s·ª≠ d·ª•ng, vui l√≤ng ch·ªçn t√™n kh√°c.",
        },
        { status: 409 }, // 409 Conflict
      );
    }

    // 3. M√£ h√≥a m·∫≠t kh·∫©u
    const hashedPassword = await bcrypt.hash(password, 10);

    // 4. T·∫°o User m·ªõi
    // L∆∞u √Ω: isActive = false (Ch·ªù duy·ªát), role = USER
    const newUser = await prisma.user.create({
      data: {
        username,
        password: hashedPassword,
        fullName,
        processId: parseInt(processId), // Chuy·ªÉn processId t·ª´ chu·ªói sang s·ªë
        role: "USER", // M·∫∑c ƒë·ªãnh l√† nh√¢n vi√™n th∆∞·ªùng
        accessLevel: "READ_ONLY", // M·∫∑c ƒë·ªãnh quy·ªÅn th·∫•p nh·∫•t
        isActive: false, // Quan tr·ªçng: Ph·∫£i ch·ªù Admin duy·ªát
      },
    });

    // 5. Tr·∫£ v·ªÅ th√¥ng b√°o th√†nh c√¥ng
    return NextResponse.json(
      {
        message:
          "ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng b√°o cho Qu·∫£n tr·ªã vi√™n ƒë·ªÉ k√≠ch ho·∫°t t√†i kho·∫£n.",
      },
      { status: 201 },
    );
  } catch (error) {
    console.error("L·ªói ƒëƒÉng k√Ω:", error);
    return NextResponse.json(
      { error: "L·ªói h·ªá th·ªëng, kh√¥ng th·ªÉ ƒëƒÉng k√Ω l√∫c n√†y." },
      { status: 500 },
    );
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\auth\register\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\auth\[...nextauth]\route.ts
================================================================================
// src/app/api/auth/[...nextauth]/route.ts
import { handlers } from "@/auth"; // Import t·ª´ file auth.ts v·ª´a t·∫°o
export const { GET, POST } = handlers;


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\auth\[...nextauth]\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\factories\route.ts
================================================================================
// src/app/api/factories/route.ts

import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

// 1. H√ÄM GET: TR·∫¢ V·ªÄ DANH S√ÅCH NH√Ä M√ÅY
export async function GET() {
  try {
    const factories = await prisma.factory.findMany({
      orderBy: { id: "asc" },
    });
    return NextResponse.json(factories);
  } catch (error) {
    return NextResponse.json(
      { error: "L·ªói khi t·∫£i danh s√°ch nh√† m√°y: " + error },
      { status: 500 }
    );
  }
}

// 2. H√ÄM POST: T·∫†O M·ªöI NH√Ä M√ÅY
export async function POST(request: Request) {
  try {
    const body = await request.json(); // L·∫•y d·ªØ li·ªáu t·ª´ ph√≠a Client g·ª≠i l√™n
    const { name, note } = body; // L·∫•y d·ªØ li·ªáu t·ª´ body

    // Valdate c∆° b·∫£n
    if (!name) {
      return NextResponse.json(
        { error: "B·∫Øt bu·ªôc nh·∫≠p t√™n nh√† m√°y!" },
        { status: 400 }
      );
    }

    // ƒê·∫©y d·ªØ li·ªáu v√†o CSDL
    const newFactory = await prisma.factory.create({
      data: {
        name: name,
        note: note,
      },
    });

    // Tr·∫£ v·ªÅ th√¥ng tin nh√† m√°y v·ª´a th√™m th√†nh c√¥ng
    return NextResponse.json(newFactory, { status: 201 });
  } catch (error) {
    return NextResponse.json(
      { error: "L·ªói khi th√™m nh√† m√°y: " + error },
      { status: 500 }
    );
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\factories\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\factories\[id]\route.ts
================================================================================
// app/api/factories/[id]/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

// 1. H√ÄM PUT: C·∫≠p nh·∫≠t th√¥ng tin
export async function PUT(
  request: Request,
  // S·ª≠a ki·ªÉu d·ªØ li·ªáu c·ªßa params th√†nh Promise
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    // --- KH·∫ÆC PH·ª§C L·ªñI ·ªû ƒê√ÇY ---
    // Ph·∫£i await params tr∆∞·ªõc khi l·∫•y id
    const data = await params;
    const idString = data.id; // L·∫•y gi√° tr·ªã c·ªßa 'id' nh∆∞ng g√°n v√†o bi·∫øn t√™n l√† 'idString'
    const id = parseInt(idString);
    // ---------------------------

    const body = await request.json();
    const { name, note } = body;

    const updatedFactory = await prisma.factory.update({
      where: { id: id },
      data: { name, note },
    });

    return NextResponse.json(updatedFactory);
  } catch (error) {
    // Log l·ªói ra terminal ƒë·ªÉ d·ªÖ debug
    console.error("L·ªói PUT:", error);
    return NextResponse.json({ error: "L·ªói c·∫≠p nh·∫≠t" }, { status: 500 });
  }
}

// 2. H√ÄM DELETE: X√≥a nh√† m√°y
export async function DELETE(
  request: Request,
  // S·ª≠a ki·ªÉu d·ªØ li·ªáu c·ªßa params th√†nh Promise
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    // --- KH·∫ÆC PH·ª§C L·ªñI ·ªû ƒê√ÇY ---
    const { id: idString } = await params;
    const id = parseInt(idString);
    // ---------------------------

    await prisma.factory.delete({
      where: { id: id },
    });
    return NextResponse.json({ message: "X√≥a th√†nh c√¥ng" }, { status: 200 });
  } catch (error) {
    console.error("L·ªói DELETE:", error);
    return NextResponse.json(
      { error: "Kh√¥ng x√≥a ƒë∆∞·ª£c, c√≥ th·ªÉ do r√†ng bu·ªôc d·ªØ li·ªáu" },
      { status: 500 }
    );
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\factories\[id]\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\items\route.ts
================================================================================
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { auth } from "@/auth";

// 1. GET: L·∫•y danh s√°ch (C√≥ l·ªçc)
export async function GET(request: Request) {
  try {
    const { searchParams } = new URL(request.url);
    const search = searchParams.get("search");

    const where: any = {};
    if (search) {
      where.OR = [
        { name: { contains: search, mode: "insensitive" } },
        { code: { contains: search, mode: "insensitive" } },
      ];
    }

    const items = await prisma.item.findMany({
      where,
      orderBy: { name: "asc" },
      include: {
        _count: { select: { productionLogs: true } },
      },
    });

    return NextResponse.json(items);
  } catch (error) {
    console.error(error);
    return NextResponse.json({ error: "L·ªói t·∫£i danh s√°ch" }, { status: 500 });
  }
}

// 2. POST: T·∫°o m·ªõi
export async function POST(req: Request) {
  try {
    const session = await auth();
    // Check quy·ªÅn Admin ho·∫∑c Manager
    if (
      session?.user?.role !== "ADMIN" &&
      session?.user?.accessLevel !== "MANAGER"
    ) {
      return NextResponse.json({ error: "Kh√¥ng c√≥ quy·ªÅn" }, { status: 403 });
    }

    const body = await req.json();
    const { name, code, ne, composition, twist, weavingStyle, material } = body;

    if (!name)
      return NextResponse.json({ error: "T√™n b·∫Øt bu·ªôc" }, { status: 400 });

    // Check tr√πng t√™n
    const exists = await prisma.item.findUnique({ where: { name } });
    if (exists)
      return NextResponse.json({ error: "T√™n ƒë√£ t·ªìn t·∫°i" }, { status: 409 });

    const newItem = await prisma.item.create({
      data: {
        name,
        code,
        ne: ne ? parseInt(ne) : null,
        composition,
        twist: twist ? parseInt(twist) : null,
        weavingStyle,
        material,
      },
    });

    return NextResponse.json(newItem, { status: 201 });
  } catch (error) {
    console.error(error);
    return NextResponse.json({ error: "L·ªói t·∫°o m·ªõi" }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\items\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\items\[id]\route.ts
================================================================================
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { auth } from "@/auth";

// 1. PUT: C·∫≠p nh·∫≠t (D·ª±a v√†o ID tr√™n URL)
export async function PUT(
  req: Request,
  { params }: { params: Promise<{ id: string }> }, // L∆∞u √Ω: Next.js 15+ params l√† Promise
) {
  try {
    const session = await auth();
    if (
      session?.user?.role !== "ADMIN" &&
      session?.user?.accessLevel !== "MANAGER"
    ) {
      return NextResponse.json({ error: "Kh√¥ng c√≥ quy·ªÅn" }, { status: 403 });
    }

    // Await params ƒë·ªÉ l·∫•y ID
    const { id } = await params;
    const itemId = parseInt(id);

    const body = await req.json();
    const { name, code, ne, composition, twist, weavingStyle, material } = body;

    const updatedItem = await prisma.item.update({
      where: { id: itemId },
      data: {
        name,
        code,
        ne: ne ? parseInt(ne) : null,
        composition,
        twist: twist ? parseInt(twist) : null,
        weavingStyle,
        material,
      },
    });

    return NextResponse.json(updatedItem);
  } catch (error) {
    console.error(error);
    return NextResponse.json({ error: "L·ªói c·∫≠p nh·∫≠t" }, { status: 500 });
  }
}

// 2. DELETE: X√≥a (D·ª±a v√†o ID tr√™n URL)
export async function DELETE(
  req: Request,
  { params }: { params: Promise<{ id: string }> },
) {
  try {
    const session = await auth();
    if (session?.user?.role !== "ADMIN") {
      return NextResponse.json(
        { error: "Ch·ªâ Admin ƒë∆∞·ª£c x√≥a" },
        { status: 403 },
      );
    }

    const { id } = await params;
    const itemId = parseInt(id);

    // Ki·ªÉm tra r√†ng bu·ªôc
    const item = await prisma.item.findUnique({
      where: { id: itemId },
      include: { _count: { select: { productionLogs: true } } },
    });

    if (item && item._count.productionLogs > 0) {
      return NextResponse.json(
        { error: "M·∫∑t h√†ng n√†y ƒë√£ c√≥ d·ªØ li·ªáu s·∫£n xu·∫•t, kh√¥ng th·ªÉ x√≥a!" },
        { status: 400 },
      );
    }

    await prisma.item.delete({ where: { id: itemId } });

    return NextResponse.json({ message: "ƒê√£ x√≥a th√†nh c√¥ng" });
  } catch (error) {
    console.error(error);
    return NextResponse.json({ error: "L·ªói x√≥a d·ªØ li·ªáu" }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\items\[id]\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\machines\batch\route.ts
================================================================================
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { auth } from "@/auth";

export async function POST(req: Request) {
  try {
    const session = await auth();
    // Ch·ªâ Admin ho·∫∑c Manager m·ªõi ƒë∆∞·ª£c ƒëi·ªÅu ph·ªëi
    if (
      session?.user?.role !== "ADMIN" &&
      session?.user?.accessLevel !== "MANAGER"
    ) {
      return NextResponse.json(
        { error: "Kh√¥ng c√≥ quy·ªÅn ƒëi·ªÅu ph·ªëi" },
        { status: 403 },
      );
    }

    const body = await req.json();
    const { machineIds, itemId } = body;

    if (!machineIds || machineIds.length === 0 || !itemId) {
      return NextResponse.json(
        { error: "D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá" },
        { status: 400 },
      );
    }

    // 1. L·∫•y th√¥ng tin M·∫∑t h√†ng ƒë·ªÉ bi·∫øt NE m·∫∑c ƒë·ªãnh
    const item = await prisma.item.findUnique({
      where: { id: parseInt(itemId) },
    });
    if (!item)
      return NextResponse.json(
        { error: "M·∫∑t h√†ng kh√¥ng t·ªìn t·∫°i" },
        { status: 404 },
      );

    // 2. C·∫≠p nh·∫≠t h√†ng lo·∫°t (Batch Update)
    // C·∫≠p nh·∫≠t c·∫£ currentItemId v√† currentNE (l·∫•y theo NE c·ªßa m·∫∑t h√†ng)
    await prisma.machine.updateMany({
      where: {
        id: { in: machineIds },
      },
      data: {
        currentItemId: item.id,
        currentNE: item.ne || 0, // T·ª± ƒë·ªông set NE theo m·∫∑t h√†ng ƒë·ªÉ c√¥ng nh√¢n ƒë·ª° ph·∫£i nh·∫≠p
      },
    });

    return NextResponse.json({
      message: `ƒê√£ ƒëi·ªÅu ph·ªëi xong ${machineIds.length} m√°y!`,
    });
  } catch (error) {
    console.error(error);
    return NextResponse.json({ error: "L·ªói h·ªá th·ªëng" }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\machines\batch\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\machines\route.ts
================================================================================
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

export async function GET(request: Request) {
  const { searchParams } = new URL(request.url);
  const factoryId = searchParams.get("factoryId");
  const processId = searchParams.get("processId");

  const where: any = {};
  if (factoryId) where.process = { factoryId: parseInt(factoryId) };
  if (processId) where.processId = parseInt(processId);

  const machines = await prisma.machine.findMany({
    where,
    include: {
      process: { include: { factory: true } },
      currentItem: true, // L·∫•y t√™n m·∫∑t h√†ng ƒëang ch·∫°y
    },
    orderBy: [{ processId: "asc" }, { id: "asc" }],
  });

  return NextResponse.json(machines);
}

export async function POST(req: Request) {
  // ... (Code check quy·ªÅn Admin t∆∞∆°ng t·ª± c√°c file kh√°c) ...
  try {
    const body = await req.json();
    const newMachine = await prisma.machine.create({
      data: {
        name: body.name,
        processId: parseInt(body.processId),
        formulaType: parseInt(body.formulaType),
        spindleCount: body.spindleCount
          ? parseInt(body.spindleCount)
          : undefined,
        isActive: body.isActive !== false,
      },
    });
    return NextResponse.json(newMachine);
  } catch (e) {
    return NextResponse.json({ error: "L·ªói t·∫°o m√°y" }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\machines\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\machines\[id]\route.ts
================================================================================
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

export async function PUT(
  req: Request,
  { params }: { params: Promise<{ id: string }> },
) {
  try {
    const { id } = await params;
    const body = await req.json();

    // X·ª≠ l√Ω update t·ª´ng tr∆∞·ªùng m·ªôt ƒë·ªÉ an to√†n
    const updated = await prisma.machine.update({
      where: { id: parseInt(id) },
      data: {
        name: body.name,
        processId: parseInt(body.processId),
        formulaType: parseInt(body.formulaType),
        spindleCount: body.spindleCount,
        isActive: body.isActive,
        // Kh√¥ng update currentItemId ·ªü ƒë√¢y, d√πng API Batch kia chuy√™n nghi·ªáp h∆°n
      },
    });
    return NextResponse.json(updated);
  } catch (e) {
    return NextResponse.json({ error: "L·ªói c·∫≠p nh·∫≠t" }, { status: 500 });
  }
}

export async function DELETE(
  req: Request,
  { params }: { params: Promise<{ id: string }> },
) {
  try {
    const { id } = await params;
    // Check r√†ng bu·ªôc: M√°y ƒë√£ s·∫£n xu·∫•t ch∆∞a?
    const count = await prisma.productionLog.count({
      where: { machineId: parseInt(id) },
    });
    if (count > 0)
      return NextResponse.json(
        {
          error:
            "M√°y ƒë√£ c√≥ d·ªØ li·ªáu s·∫£n xu·∫•t, ch·ªâ ƒë∆∞·ª£c ph√©p T·∫Øt ho·∫°t ƒë·ªông (Disable) ch·ª© kh√¥ng th·ªÉ X√≥a!",
        },
        { status: 400 },
      );

    await prisma.machine.delete({ where: { id: parseInt(id) } });
    return NextResponse.json({ message: "ƒê√£ x√≥a" });
  } catch (e) {
    return NextResponse.json({ error: "L·ªói x√≥a" }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\machines\[id]\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\processes\route.ts
================================================================================
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

// --- H√ÄM L·∫§Y DANH S√ÅCH C√îNG ƒêO·∫†N ---
export async function GET() {
  try {
    // K·ªπ thu·∫≠t Eager Loading: L·∫•y k√®m d·ªØ li·ªáu b·∫£ng cha (Factory)
    const processes = await prisma.process.findMany({
      include: {
        factory: true, // <-- Quan tr·ªçng: L·∫•y th√¥ng tin nh√† m√°y
      },
      orderBy: { id: "asc" },
    });
    return NextResponse.json(processes);
  } catch (error) {
    return NextResponse.json(
      { error: "L·ªói l·∫•y d·ªØ li·ªáu c√¥ng ƒëo·∫°n: " + error },
      { status: 500 },
    );
  }
}

// --- H√ÄM TH√äM M·ªöI C√îNG ƒêO·∫†N ---
export async function POST(request: Request) {
  try {
    const body = await request.json();
    const { name, factoryId } = body;

    if (!name || !factoryId) {
      return NextResponse.json(
        { error: "B·∫Øt bu·ªôc nh·∫≠p t√™n c√¥ng ƒëo·∫°n v√† t√™n nh√† m√°y!" },
        { status: 400 },
      );
    }

    const newProcess = await prisma.process.create({
      data: {
        name: name,
        factoryId: parseInt(factoryId),
      },
      include: { factory: true }, // // Tr·∫£ v·ªÅ k√®m th√¥ng tin nh√† m√°y ƒë·ªÉ frontend hi·ªÉn th·ªã ngay
    });

    return NextResponse.json(newProcess, { status: 200 });
  } catch (error) {
    return NextResponse.json(
      { error: "L·ªói th√™m m·ªõi d·ªØ li·ªáu: " + error },
      { status: 500 },
    );
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\processes\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\processes\[id]\route.ts
================================================================================
import { error } from "console";
// app/api/processes/[id]/route.ts
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { message } from "antd";

// --- PUT. H√ÄM C·∫¨P NH·∫¨T ---
export async function PUT(
  request: Request,
  { params }: { params: Promise<{ id: string }> } // C√∫ ph√°p an to√†n
) {
  try {
    const data = await params; // ƒê·ª£i d·ªØ li·ªáu t·ª´ Promise params
    const idString = data.id; // G√°n id d·∫°ng chu·ªói cho idString
    const id = parseInt(idString); // Bi·∫øn ƒë·ªïi chu·ªói th√†nh s·ªë
    const body = await request.json(); // L·∫•y d·ªØ li·ªáu t·ª´ Client g·ª≠i l√™n
    const { name, factoryId } = body; // Destructuring

    // G·ªçi Prisma ra c·∫≠p nh·∫≠t d·ªØ li·ªáu
    // ƒê·ªìng th·ªùi g√°n d·ªØ li·ªáu m·ªõi update cho bi·∫øn updated ƒë·ªÉ b√°o v·ªÅ client
    const updated = await prisma.process.update({
      where: { id: id },
      data: {
        name: name,
        factoryId: parseInt(factoryId),
      },
      include: { factory: true },
    });

    return NextResponse.json(updated);
  } catch (error) {
    return NextResponse.json(
      { error: "L·ªói c·∫≠p nh·∫≠t: " + error },
      { status: 500 }
    );
  }
}

// --- DELETE. H√ÄM X√ìA ---
export async function DELETE(
  request: Request,
  { params }: { params: Promise<{ id: string }> } // C√∫ ph√°p an to√†n
) {
  try {
    const data = await params;
    const idString = data.id;
    const id = parseInt(idString);

    await prisma.process.delete({
      where: { id: id },
    });

    return NextResponse.json(
      { message: "ƒê√£ x√≥a th√†nh c√¥ng!" },
      { status: 200 }
    );
  } catch (error) {
    return NextResponse.json(
      { error: "L·ªói x√≥a d·ªØ li·ªáu ·ªü server: " + error },
      { status: 500 }
    );
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\processes\[id]\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\production\daily-input\route.ts
================================================================================
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { auth } from "@/auth";

export async function POST(request: Request) {
  try {
    // 1. L·∫§Y TH√îNG TIN NG∆Ø·ªúI D√ôNG
    const session = await auth();
    if (!session || !session.user || !session.user.id) {
      return NextResponse.json({ error: "Ch∆∞a ƒëƒÉng nh·∫≠p" }, { status: 401 });
    }

    const body = await request.json();
    const { recordDate, note } = body;
    let {
      machineId,
      shift,
      itemId,
      startIndex,
      endIndex,
      inputNE,
      finalOutput,
    } = body;

    // Validate Input
    if (!machineId || !recordDate || !shift) {
      return NextResponse.json(
        { error: "Thi·∫øu th√¥ng tin b·∫Øt bu·ªôc" },
        { status: 400 },
      );
    }

    // √âp ki·ªÉu an to√†n
    machineId = parseInt(machineId);
    shift = parseInt(shift);
    itemId = parseInt(itemId);
    startIndex = startIndex !== null ? parseFloat(startIndex) : 0; // L∆∞u 0 n·∫øu null
    endIndex = endIndex !== null ? parseFloat(endIndex) : null;
    inputNE = inputNE ? parseFloat(inputNE) : null;
    finalOutput = parseFloat(finalOutput);

    // 2. LOGIC B·∫¢O M·∫¨T: KI·ªÇM TRA QUY·ªÄN NH·∫¨P LI·ªÜU
    // N·∫øu kh√¥ng ph·∫£i ADMIN, b·∫Øt bu·ªôc ph·∫£i ki·ªÉm tra Process
    if (session.user.role !== "ADMIN") {
      // L·∫•y th√¥ng tin m√°y ƒë·ªÉ bi·∫øt n√≥ thu·ªôc c√¥ng ƒëo·∫°n n√†o
      const targetMachine = await prisma.machine.findUnique({
        where: { id: machineId },
        select: { processId: true },
      });

      if (!targetMachine) {
        return NextResponse.json(
          { error: "M√°y kh√¥ng t·ªìn t·∫°i" },
          { status: 404 },
        );
      }

      // So s√°nh c√¥ng ƒëo·∫°n c·ªßa User v√† c√¥ng ƒëo·∫°n c·ªßa M√°y
      // User.processId c√≥ th·ªÉ l√† null, c·∫ßn √©p ki·ªÉu ho·∫∑c check k·ªπ
      const userProcessId = Number(session.user.processId);

      if (userProcessId !== targetMachine.processId) {
        return NextResponse.json(
          {
            error:
              "B·∫†N KH√îNG C√ì QUY·ªÄN! T√†i kho·∫£n c·ªßa b·∫°n kh√¥ng ƒë∆∞·ª£c ph√©p nh·∫≠p li·ªáu cho m√°y thu·ªôc c√¥ng ƒëo·∫°n n√†y.",
          },
          { status: 403 },
        );
      }
    }

    // X·ª≠ l√Ω Date: Gi·ªØ nguy√™n ng√†y YYYY-MM-DD t·ª´ client g·ª≠i l√™n ƒë·ªÉ tr√°nh l·ªách m√∫i gi·ªù
    const dateObj = new Date(recordDate);

    // T√¨m xem ƒë√£ c√≥ ch∆∞a (Update hay Create)
    const existingLog = await prisma.productionLog.findFirst({
      where: {
        machineId,
        recordDate: dateObj,
        shift,
      },
    });

    let savedLog;
    const dataToSave = {
      machineId,
      recordDate: dateObj,
      shift,
      itemId,
      startIndex, // ƒê√£ c√≥ trong Schema
      endIndex,
      inputNE,
      finalOutput,
      note,
      createdById: parseInt(session.user.id), // <-- L∆∞u ID ng∆∞·ªùi nh·∫≠p v√†o ƒë√¢y
    };

    if (existingLog) {
      savedLog = await prisma.productionLog.update({
        where: { id: existingLog.id },
        data: dataToSave,
      });
    } else {
      savedLog = await prisma.productionLog.create({
        data: dataToSave,
      });
    }

    // Update NE cho m√°y ƒë·ªÉ l·∫ßn sau t·ª± ƒëi·ªÅn
    if (inputNE) {
      await prisma.machine.update({
        where: { id: machineId },
        data: { currentNE: parseFloat(inputNE) },
      });
    }

    return NextResponse.json(savedLog);
  } catch (error) {
    console.error("Save Error:", error);
    return NextResponse.json({ error: "L·ªói h·ªá th·ªëng" }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\production\daily-input\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\production\daily-status\route.ts
================================================================================
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

export async function GET(request: Request) {
  try {
    const { searchParams } = new URL(request.url);
    const processId = searchParams.get("processId");
    const dateStr = searchParams.get("date");
    const shift = searchParams.get("shift");

    if (!processId || !dateStr || !shift) return NextResponse.json([]);

    const targetDate = new Date(dateStr);

    const machines = await prisma.machine.findMany({
      where: {
        processId: parseInt(processId),
        isActive: true,
      },
      include: {
        currentItem: true,
        // K·ªπ thu·∫≠t: Include lu√¥n log c·ªßa Ca/Ng√†y ƒëang ch·ªçn
        productionLogs: {
          where: {
            recordDate: targetDate,
            shift: parseInt(shift),
          },
          take: 1,
        },
      },
      orderBy: { id: "asc" },
    });

    // Format l·∫°i d·ªØ li·ªáu cho Frontend d·ªÖ d√πng
    const formattedData = machines.map((m) => ({
      ...m,
      todayLog: m.productionLogs.length > 0 ? m.productionLogs[0] : null,
      productionLogs: undefined, // X√≥a m·∫£ng g·ªëc cho nh·∫π
    }));

    return NextResponse.json(formattedData);
  } catch (error) {
    return NextResponse.json({ error: "L·ªói server" }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\production\daily-status\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\production\history\route.ts
================================================================================
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import { auth } from "@/auth";

export async function POST(request: Request) {
  try {
    const session = await auth();
    if (!session)
      return NextResponse.json({ error: "Ch∆∞a ƒëƒÉng nh·∫≠p" }, { status: 401 });

    const body = await request.json();
    const {
      fromDate,
      toDate,
      factoryIds,
      processIds,
      machineIds,
      shifts,
      itemIds,
      page = 1,
      pageSize = 20, // M·∫∑c ƒë·ªãnh trang 1, 20 d√≤ng/trang
    } = body;

    // 1. X√¢y d·ª±ng ƒëi·ªÅu ki·ªán l·ªçc (Where)
    const where: any = {};

    if (fromDate && toDate) {
      where.recordDate = { gte: new Date(fromDate), lte: new Date(toDate) };
    }
    if (shifts?.length > 0) where.shift = { in: shifts };
    if (machineIds?.length > 0) where.machineId = { in: machineIds };
    if (itemIds?.length > 0) where.itemId = { in: itemIds };

    // L·ªçc theo C√¥ng ƒëo·∫°n/Nh√† m√°y n·∫øu ch∆∞a ch·ªçn M√°y c·ª• th·ªÉ
    if (
      (!machineIds || machineIds.length === 0) &&
      (processIds?.length > 0 || factoryIds?.length > 0)
    ) {
      where.machine = {};
      if (processIds?.length > 0) where.machine.processId = { in: processIds };
      // N·∫øu c·∫ßn l·ªçc theo factory m√† ch∆∞a ch·ªçn process (Logic n√¢ng cao)
    }

    // 2. CH·∫†Y SONG SONG 3 TRUY V·∫§N (TRANSACTION)
    // - Query 1: L·∫•y danh s√°ch ph√¢n trang (Data)
    // - Query 2: ƒê·∫øm t·ªïng s·ªë b·∫£n ghi (Total Count - ƒë·ªÉ chia trang)
    // - Query 3: T√≠nh t·ªïng s·∫£n l∆∞·ª£ng to√†n b·ªô (Grand Total - cho Dashboard)

    const [logs, totalCount, aggregate] = await prisma.$transaction([
      // Query 1: Data Pagination
      prisma.productionLog.findMany({
        where,
        skip: (page - 1) * pageSize, // B·ªè qua c√°c d√≤ng c·ªßa trang tr∆∞·ªõc
        take: pageSize, // Ch·ªâ l·∫•y s·ªë d√≤ng c·ªßa trang hi·ªán t·∫°i
        include: {
          machine: { include: { process: { include: { factory: true } } } },
          item: true,
          createdBy: { select: { fullName: true } },
        },
        orderBy: [{ recordDate: "desc" }, { shift: "desc" }],
      }),

      // Query 2: Count
      prisma.productionLog.count({ where }),

      // Query 3: Sum Output
      prisma.productionLog.aggregate({
        where,
        _sum: { finalOutput: true },
      }),
    ]);

    return NextResponse.json({
      data: logs,
      pagination: {
        total: totalCount,
        current: page,
        pageSize: pageSize,
      },
      stats: {
        totalOutput: aggregate._sum.finalOutput || 0,
      },
    });
  } catch (error) {
    console.error("Report Error:", error);
    return NextResponse.json({ error: "L·ªói h·ªá th·ªëng" }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\production\history\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\production\last-log\route.ts
================================================================================
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";

export async function GET(request: Request) {
  try {
    const { searchParams } = new URL(request.url);
    const machineId = searchParams.get("machineId");
    const dateStr = searchParams.get("date");
    const shiftStr = searchParams.get("shift");

    if (!machineId || !dateStr || !shiftStr) return NextResponse.json(null);

    const targetDate = new Date(dateStr);
    const targetShift = parseInt(shiftStr);

    // Logic: T√¨m b·∫£n ghi c√≥ (Ng√†y nh·ªè h∆°n) HO·∫∂C (Ng√†y b·∫±ng nh∆∞ng Ca nh·ªè h∆°n)
    const lastLog = await prisma.productionLog.findFirst({
      where: {
        machineId: parseInt(machineId),
        OR: [
          { recordDate: { lt: targetDate } },
          {
            recordDate: targetDate,
            shift: { lt: targetShift },
          },
        ],
      },
      orderBy: [
        { recordDate: "desc" }, // Ng√†y g·∫ßn nh·∫•t
        { shift: "desc" }, // Ca l·ªõn nh·∫•t trong ng√†y ƒë√≥
      ],
    });

    return NextResponse.json(lastLog);
  } catch (error) {
    console.error("Get Error:", error);
    return NextResponse.json({ error: "L·ªói truy v·∫•n" }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\production\last-log\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\profile\change-password\route.ts
================================================================================
import { NextResponse } from "next/server";
import { auth } from "@/auth";
import { prisma } from "@/lib/prisma";
import * as bcrypt from "bcryptjs";

export async function POST(req: Request) {
  try {
    // 1. Ki·ªÉm tra session
    const session = await auth();

    // --- IN RA TERMINAL ƒê·ªÇ KI·ªÇM TRA ---
    console.log(">>> [DEBUG] Session User:", session?.user);

    if (!session || !session.user) {
      return NextResponse.json(
        { error: "B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p" },
        { status: 401 },
      );
    }

    const body = await req.json();
    const { currentPassword, newPassword } = body;

    // 2. Validate input
    if (!currentPassword || !newPassword) {
      return NextResponse.json(
        { error: "Thi·∫øu th√¥ng tin m·∫≠t kh·∫©u" },
        { status: 400 },
      );
    }

    // 3. X·ª¨ L√ù ID (QUAN TR·ªåNG NH·∫§T)
    // NextAuth tr·∫£ v·ªÅ id l√† string, ta ph·∫£i √©p ki·ªÉu v·ªÅ s·ªë
    const userIdString = session.user.id;
    const userId = parseInt(userIdString || "0"); // √âp ki·ªÉu sang s·ªë nguy√™n

    console.log(
      `>>> [DEBUG] ƒêang t√¨m User c√≥ ID: ${userId} (Ki·ªÉu g·ªëc: ${typeof userIdString})`,
    );

    if (!userId || isNaN(userId)) {
      return NextResponse.json(
        { error: "L·ªói phi√™n ƒëƒÉng nh·∫≠p (ID kh√¥ng h·ª£p l·ªá)" },
        { status: 401 },
      );
    }

    // 4. T√¨m User trong Database
    const user = await prisma.user.findUnique({
      where: { id: userId }, // Prisma c·∫ßn ID l√† s·ªë (Int)
    });

    // --- ƒê√ÇY L√Ä CH·ªñ G√ÇY RA L·ªñI 404 C·ª¶A B·∫†N ---
    if (!user) {
      console.log(">>> [LOI] Kh√¥ng t√¨m th·∫•y user trong DB!");
      return NextResponse.json(
        { error: "Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n" },
        { status: 404 },
      );
    }

    // 5. Ki·ªÉm tra m·∫≠t kh·∫©u c≈©
    const isPasswordValid = await bcrypt.compare(
      currentPassword,
      user.password,
    );
    if (!isPasswordValid) {
      return NextResponse.json(
        { error: "M·∫≠t kh·∫©u hi·ªán t·∫°i kh√¥ng ƒë√∫ng" },
        { status: 400 },
      );
    }

    // 6. C·∫≠p nh·∫≠t m·∫≠t kh·∫©u
    const hashedNewPassword = await bcrypt.hash(newPassword, 10);
    await prisma.user.update({
      where: { id: userId },
      data: { password: hashedNewPassword },
    });

    console.log(">>> [THANH CONG] ƒê√£ ƒë·ªïi m·∫≠t kh·∫©u!");
    return NextResponse.json({ message: "ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!" });
  } catch (error) {
    console.error(">>> [LOI SERVER]:", error);
    return NextResponse.json({ error: "L·ªói h·ªá th·ªëng" }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\profile\change-password\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\users\route.ts
================================================================================
import { NextResponse } from "next/server";
import { prisma } from "@/lib/prisma";
import * as bcrypt from "bcryptjs";
import { auth } from "@/auth";

// 1. GET: L·∫•y danh s√°ch
export async function GET() {
  try {
    const session = await auth();
    if (session?.user?.role !== "ADMIN") {
      return NextResponse.json(
        { error: "Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p" },
        { status: 403 },
      );
    }

    const users = await prisma.user.findMany({
      orderBy: { createdAt: "desc" },
      include: { process: true },
    });

    // Lo·∫°i b·ªè m·∫≠t kh·∫©u
    const safeUsers = users.map(({ password, ...rest }) => rest);
    return NextResponse.json(safeUsers);
  } catch (error) {
    console.error("Get Users Error:", error);
    return NextResponse.json({ error: "L·ªói t·∫£i danh s√°ch" }, { status: 500 });
  }
}

// 2. POST: T·∫°o m·ªõi (ƒê√É S·ª¨A: D√πng username)
export async function POST(req: Request) {
  try {
    const session = await auth();
    if (session?.user?.role !== "ADMIN") {
      return NextResponse.json(
        { error: "Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p" },
        { status: 403 },
      );
    }

    const body = await req.json();
    const { username, password, fullName, role, accessLevel, processId } = body;

    // Validate
    if (!username || !password || !fullName) {
      return NextResponse.json(
        { error: "Vui l√≤ng nh·∫≠p ƒë·ªß: Username, M·∫≠t kh·∫©u, H·ªç t√™n" },
        { status: 400 },
      );
    }

    // Ki·ªÉm tra tr√πng username
    const exists = await prisma.user.findUnique({ where: { username } });
    if (exists) {
      return NextResponse.json(
        { error: "T√™n ƒëƒÉng nh·∫≠p n√†y ƒë√£ t·ªìn t·∫°i!" },
        { status: 409 },
      );
    }

    const hashedPassword = await bcrypt.hash(password, 10);

    const newUser = await prisma.user.create({
      data: {
        username, // D√πng username
        password: hashedPassword,
        fullName,
        role: role || "USER",
        accessLevel: accessLevel || "READ_ONLY",
        processId: processId ? parseInt(processId) : null,
        isActive: true, // Admin t·∫°o th√¨ cho active lu√¥n
      },
    });

    // Tr·∫£ v·ªÅ user kh√¥ng c√≥ password
    const { password: _, ...userWithoutPass } = newUser;
    return NextResponse.json(userWithoutPass, { status: 201 });
  } catch (error) {
    console.error("Create User Error:", error);
    return NextResponse.json({ error: "L·ªói t·∫°o user m·ªõi" }, { status: 500 });
  }
}

// 3. PUT: C·∫≠p nh·∫≠t (Gi·ªØ nguy√™n logic c≈©, ch·ªâ clean code)
export async function PUT(req: Request) {
  try {
    const session = await auth();
    if (session?.user?.role !== "ADMIN") {
      return NextResponse.json(
        { error: "Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p" },
        { status: 403 },
      );
    }

    const body = await req.json();
    const {
      id,
      isActive,
      role,
      accessLevel,
      processId,
      newPassword,
      fullName,
    } = body;

    const updateData: any = {
      isActive,
      role,
      accessLevel,
      fullName,
      processId: processId ? parseInt(processId) : null,
    };

    if (newPassword && newPassword.trim() !== "") {
      const hashedPassword = await bcrypt.hash(newPassword, 10);
      updateData.password = hashedPassword;
    }

    const updatedUser = await prisma.user.update({
      where: { id: parseInt(id) },
      data: updateData,
    });

    const { password: _, ...safeUser } = updatedUser;
    return NextResponse.json(safeUser);
  } catch (error) {
    console.error("Update User Error:", error);
    return NextResponse.json({ error: "L·ªói c·∫≠p nh·∫≠t user" }, { status: 500 });
  }
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\api\users\route.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\factories\page.tsx
================================================================================
// src/app/factories/page.tsx
"use client"; // ƒê√¢y l√† Client Components

import React, { useEffect, useState } from "react";
import { Table, Button, Modal, Form, Input, message, Space, Card } from "antd";
import { PlusOutlined, EditOutlined, DeleteOutlined } from "@ant-design/icons";

// ƒê·ªãnh nghƒ©a ki·ªÉu d·ªØ li·ªáu nh√† m√°y (kh·ªõp v·ªõi Prisma)
interface Factory {
  id: number;
  name: string;
  note?: string;
}

export default function FactoryPage() {
  // Khai b√°o State
  const [factories, setFactories] = useState<Factory[]>([]);
  const [loading, setLoading] = useState(false);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingFactory, setEditingFactory] = useState<Factory | null>(null);

  const [form] = Form.useForm(); // Hook qu·∫£n l√Ω form c·ªßa Ant Design

  // --- 1. H√†m g·ªçi API ƒë·ªÉ hi·ªán d·ªØ li·ªáu (Fetch data) ---
  const fetchFactories = async () => {
    setLoading(true);
    try {
      const res = await fetch("/api/factories"); // G·ªçi API GET ta ƒë√£ vi·∫øt
      const data = await res.json();
      setFactories(data);
    } catch (error) {
      message.error("L·ªói t·∫£i d·ªØ li·ªáu: " + error);
    } finally {
      setLoading(false);
    }
  };

  // Ch·∫°y h√†m n√†y 1 l·∫ßn khi trang v·ª´a load xong
  useEffect(() => {
    fetchFactories();
  }, []);

  // --- 2. X·ª≠ l√Ω Th√™m v√† S·ª≠a ---
  const handleSave = async (values: any) => {
    try {
      let res;
      if (editingFactory) {
        // G·ªçi API PUT ƒë·ªÉ s·ª≠a
        res = await fetch(`/api/factories/${editingFactory.id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(values),
        });
        message.success("C·∫≠p nh·∫≠t th√†nh c√¥ng");
      } else {
        // G·ªçi API ƒë·ªÉ th√™m m·ªõi
        res = await fetch("/api/factories", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(values),
        });
      }

      // --- TH√äM ƒêO·∫†N KI·ªÇM TRA N√ÄY ---
      if (!res.ok) {
        const errorData = await res.json();
        throw new Error(errorData.error || "L·ªói t·ª´ server");
      }
      // -----------------------------

      message.success(
        editingFactory ? "C·∫≠p nh·∫≠t th√†nh c√¥ng" : "Th√™m m·ªõi th√†nh c√¥ng"
      );
      setIsModalOpen(false); // ƒê√≥ng Modal
      form.resetFields(); // X√≥a tr·∫Øng Form
      setEditingFactory(null);
      fetchFactories(); // Load l·∫°i b·∫£ng
    } catch (error) {
      message.error("C√≥ l·ªói x·∫£y ra: " + error);
    }
  };

  // --- 3. X·ª≠ l√Ω X√≥a ---
  const handleDelete = async (id: number) => {
    Modal.confirm({
      title: "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kh√¥ng?",
      content: "H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c",
      onOk: async () => {
        try {
          await fetch(`/api/factories/${id}`, {
            method: "DELETE",
          });
          message.success("X√≥a th√†nh c√¥ng");
          fetchFactories(); // Load l·∫°i b·∫£ng
        } catch (error) {
          message.error("L·ªói khi x√≥a: " + error);
        }
      },
    });
  };

  // --- 4. C·∫•u h√¨nh c·ªôt cho b·∫£ng d·ªØ li·ªáu ---
  const columns = [
    {
      title: "ID",
      dataIndex: "id",
      key: "id",
      width: 80,
    },
    {
      title: "T√™n Nh√† M√°y",
      dataIndex: "name",
      key: "name",
      render: (text: string) => <b>{text}</b>,
    },
    {
      title: "Ghi Ch√∫",
      dataIndex: "note",
      key: "note",
    },
    {
      title: "H√†nh ƒê·ªông",
      key: "action",
      width: 150,
      render: (_: any, record: Factory) => (
        <Space>
          <Button
            icon={<EditOutlined />}
            size="small"
            onClick={() => {
              setEditingFactory(record); // g√°n b·∫£n ghi c·∫ßn x√≥a v√†o State
              form.setFieldsValue(record); // ƒêi·ªÅn d·ªØ li·ªáu c≈© v√†o form
              setIsModalOpen(true); // M·ªü modal ƒë·ªÉ s·ª≠a
            }}
          />
          <Button
            icon={<DeleteOutlined />}
            danger
            size="small"
            onClick={() => handleDelete(record.id)}
          />
        </Space>
      ),
    },
  ];

  return (
    <div style={{ padding: 20 }}>
      <Card
        title="Qu·∫£n l√Ω danh m·ª•c Nh√† M√°y"
        extra={
          <Button
            type="primary"
            icon={<PlusOutlined />}
            onClick={() => {
              setEditingFactory(null); // ƒê√°nh d·∫•u l√† th√™m m·ªõi
              form.resetFields(); // X√≥a tr·∫Øng form ƒë·ªÉ ƒëi·ªÅn d·ªØ li·ªáu m·ªõi
              setIsModalOpen(true); // M·ªü √¥ modal nh·∫≠p li·ªáu
            }}
          >
            Th√™m Nh√† M√°y
          </Button>
        }
      >
        <Table
          rowKey="id"
          columns={columns}
          dataSource={factories}
          loading={loading}
          bordered
        ></Table>
      </Card>

      {/* Modal Form Th√™m/S·ª≠a */}
      <Modal
        title={editingFactory ? "S·ª≠a Nh√† M√°y" : "Th√™m Nh√† M√°y M·ªõi"}
        open={isModalOpen}
        onCancel={() => setIsModalOpen(false)}
        footer={null} // ·∫®n n√∫t m·∫∑c ƒë·ªãnh ƒë·ªÉ d√πng n√∫t c·ªßa Form
      >
        <Form form={form} layout="vertical" onFinish={handleSave}>
          <Form.Item
            name="name"
            label="T√™n Nh√† M√°y"
            rules={[{ required: true, message: "Vui l√≤ng nh·∫≠p t√™n!" }]}
          >
            <Input placeholder="V√≠ d·ª•: Nh√† m√°y 1" />
          </Form.Item>

          <Form.Item name="note" label="Ghi ch√∫">
            <Input.TextArea rows={3} />
          </Form.Item>

          <div style={{ textAlign: "right" }}>
            <Space>
              <Button onClick={() => setIsModalOpen(false)}>H·ªßy</Button>
              <Button type="primary" htmlType="submit">
                {editingFactory ? "C·∫≠p Nh·∫≠t" : "L∆∞u L·∫°i"}
              </Button>
            </Space>
          </div>
        </Form>
      </Modal>
    </div>
  );
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\factories\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\globals.css
================================================================================
@import "tailwindcss";

:root {
  --background: #ffffff;
  --foreground: #171717;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

@media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\globals.css ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\items\page.tsx
================================================================================
"use client";

import React, { useEffect, useState } from "react";
import { Table, Button, Modal, Form, Input, InputNumber, message, Card, Space, Popconfirm, Tag } from "antd";
import { PlusOutlined, EditOutlined, DeleteOutlined, ReloadOutlined, SearchOutlined } from "@ant-design/icons";
import { useSession } from "next-auth/react";

interface ItemData {
    id: number;
    name: string;
    code?: string;
    ne?: number;
    composition?: string;
    twist?: number;
    weavingStyle?: string;
    material?: string;
    _count?: { productionLogs: number };
}

export default function ItemsManagementPage() {
    const { data: session } = useSession();
    const [items, setItems] = useState<ItemData[]>([]);
    const [loading, setLoading] = useState(false);
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [editingItem, setEditingItem] = useState<ItemData | null>(null);
    const [searchText, setSearchText] = useState("");

    const [form] = Form.useForm();

    // --- 1. Load d·ªØ li·ªáu ---
    const fetchItems = async () => {
        setLoading(true);
        try {
            const query = searchText ? `?search=${encodeURIComponent(searchText)}` : "";
            const res = await fetch(`/api/items${query}`);
            if (res.ok) {
                setItems(await res.json());
            } else {
                message.error("Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch");
            }
        } catch (e) {
            message.error("L·ªói k·∫øt n·ªëi");
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        fetchItems();
    }, []);

    // --- 2. X·ª≠ l√Ω L∆∞u (Th√™m/S·ª≠a) ---
    // --- 2. X·ª≠ l√Ω L∆∞u (Th√™m/S·ª≠a) ---
    const handleSave = async (values: any) => {
        try {
            // N·∫øu c√≥ editingItem -> PUT v√†o /api/items/[id]
            // N·∫øu kh√¥ng -> POST v√†o /api/items

            const url = editingItem
                ? `/api/items/${editingItem.id}`
                : "/api/items";

            const method = editingItem ? "PUT" : "POST";

            const res = await fetch(url, {
                method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(values),
            });

            const data = await res.json();
            if (!res.ok) throw new Error(data.error || "L·ªói l∆∞u d·ªØ li·ªáu");

            message.success(editingItem ? "C·∫≠p nh·∫≠t th√†nh c√¥ng!" : "T·∫°o m·ªõi th√†nh c√¥ng!");
            setIsModalOpen(false);
            setEditingItem(null);
            form.resetFields();
            fetchItems();
        } catch (error: any) {
            message.error(error.message);
        }
    };

    // --- 3. X·ª≠ l√Ω X√≥a ---
    const handleDelete = async (id: number) => {
        try {
            // G·ªçi ƒë√∫ng chu·∫©n RESTful: DELETE /api/items/[id]
            const res = await fetch(`/api/items/${id}`, { method: "DELETE" });

            const data = await res.json();
            if (!res.ok) throw new Error(data.error);

            message.success("ƒê√£ x√≥a m·∫∑t h√†ng");
            fetchItems();
        } catch (error: any) {
            message.error(error.message);
        }
    };

    // --- 4. M·ªü Modal ---
    const openModal = (item?: ItemData) => {
        if (item) {
            setEditingItem(item);
            form.setFieldsValue(item);
        } else {
            setEditingItem(null);
            form.resetFields();
        }
        setIsModalOpen(true);
    };

    // --- 5. C·ªôt b·∫£ng ---
    const columns = [
        {
            title: "T√™n m·∫∑t h√†ng",
            dataIndex: "name",
            key: "name",
            render: (text: string, r: ItemData) => (
                <div>
                    <div style={{ fontWeight: 600 }}>{text}</div>
                    {r.code && <Tag color="blue">{r.code}</Tag>}
                </div>
            )
        },
        {
            title: "Chi s·ªë (NE)",
            dataIndex: "ne",
            key: "ne",
            align: 'center' as const,
            render: (ne: number) => ne ? <Tag color="geekblue">{ne}</Tag> : "-"
        },
        {
            title: "Th√†nh ph·∫ßn",
            dataIndex: "composition",
            key: "composition",
        },
        {
            title: "Th√¥ng s·ªë kh√°c",
            key: "specs",
            render: (_: any, r: ItemData) => (
                <Space direction="vertical" size={0} style={{ fontSize: 12, color: '#666' }}>
                    {r.material && <div>NL: {r.material}</div>}
                    {r.twist && <div>ƒê·ªô sƒÉn: {r.twist}</div>}
                    {r.weavingStyle && <div>Ki·ªÉu: {r.weavingStyle}</div>}
                </Space>
            )
        },
        {
            title: "Tr·∫°ng th√°i",
            key: "status",
            render: (_: any, r: ItemData) => {
                const count = r._count?.productionLogs || 0;
                return count > 0
                    ? <Tag color="green">ƒêang s·∫£n xu·∫•t ({count})</Tag>
                    : <Tag>Ch∆∞a d√πng</Tag>
            }
        },
        {
            title: "H√†nh ƒë·ªông",
            key: "action",
            align: 'right' as const,
            render: (_: any, r: ItemData) => (
                <Space>
                    <Button icon={<EditOutlined />} size="small" onClick={() => openModal(r)} />

                    <Popconfirm
                        title="X√≥a m·∫∑t h√†ng n√†y?"
                        description="H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c."
                        onConfirm={() => handleDelete(r.id)}
                        okText="X√≥a"
                        cancelText="H·ªßy"
                        disabled={(r._count?.productionLogs || 0) > 0} // Kh√≥a n√∫t x√≥a n·∫øu ƒëang d√πng
                    >
                        <Button
                            icon={<DeleteOutlined />}
                            size="small"
                            danger
                            disabled={(r._count?.productionLogs || 0) > 0}
                        />
                    </Popconfirm>
                </Space>
            ),
        },
    ];

    if (!session) return <div className="p-10 text-center">Vui l√≤ng ƒëƒÉng nh·∫≠p...</div>;

    return (
        <div className="p-6">
            <Card
                title="Danh m·ª•c M·∫∑t h√†ng S·ª£i"
                extra={
                    <Space>
                        <Input
                            placeholder="T√¨m t√™n ho·∫∑c m√£..."
                            prefix={<SearchOutlined />}
                            value={searchText}
                            onChange={e => setSearchText(e.target.value)}
                            onPressEnter={fetchItems}
                            style={{ width: 200 }}
                        />
                        <Button icon={<ReloadOutlined />} onClick={fetchItems}>T·∫£i l·∫°i</Button>
                        <Button type="primary" icon={<PlusOutlined />} onClick={() => openModal()}>Th√™m m·ªõi</Button>
                    </Space>
                }
            >
                <Table
                    rowKey="id"
                    columns={columns}
                    dataSource={items}
                    loading={loading}
                    pagination={{ pageSize: 8 }}
                    bordered
                />
            </Card>

            {/* MODAL TH√äM / S·ª¨A */}
            <Modal
                title={editingItem ? "C·∫≠p nh·∫≠t M·∫∑t h√†ng" : "Th√™m M·∫∑t h√†ng m·ªõi"}
                open={isModalOpen}
                onCancel={() => setIsModalOpen(false)}
                footer={null}
                width={600}
            >
                <Form form={form} layout="vertical" onFinish={handleSave}>
                    <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr', gap: 16 }}>
                        <Form.Item
                            name="name"
                            label="T√™n ƒë·∫ßy ƒë·ªß m·∫∑t h√†ng"
                            rules={[{ required: true, message: "Vui l√≤ng nh·∫≠p t√™n" }]}
                        >
                            <Input placeholder="V√≠ d·ª•: CVC 30 Combed" />
                        </Form.Item>

                        <Form.Item name="code" label="M√£ vi·∫øt t·∫Øt">
                            <Input placeholder="CVC30" />
                        </Form.Item>
                    </div>

                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 16 }}>
                        <Form.Item name="ne" label="Chi s·ªë (NE)">
                            <InputNumber style={{ width: '100%' }} placeholder="30" min={1} />
                        </Form.Item>

                        <Form.Item name="twist" label="ƒê·ªô sƒÉn (Twist)">
                            <InputNumber style={{ width: '100%' }} placeholder="850" />
                        </Form.Item>

                        <Form.Item name="weavingStyle" label="Ki·ªÉu d·ªát">
                            <Input placeholder="D·ªát thoi / Kim" />
                        </Form.Item>
                    </div>

                    <Form.Item name="composition" label="Th√†nh ph·∫ßn">
                        <Input placeholder="V√≠ d·ª•: 60% Cotton - 40% Poly" />
                    </Form.Item>

                    <Form.Item name="material" label="Nguy√™n li·ªáu ƒë·∫ßu v√†o">
                        <Input placeholder="V√≠ d·ª•: B√¥ng M·ªπ, X∆° Th√°i..." />
                    </Form.Item>

                    <div style={{ textAlign: "right", marginTop: 16 }}>
                        <Space>
                            <Button onClick={() => setIsModalOpen(false)}>H·ªßy b·ªè</Button>
                            <Button type="primary" htmlType="submit">
                                {editingItem ? "C·∫≠p nh·∫≠t" : "Th√™m m·ªõi"}
                            </Button>
                        </Space>
                    </div>
                </Form>
            </Modal>
        </div>
    );
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\items\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\layout.tsx
================================================================================
// app/layout.tsx
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css"; // File css m·∫∑c ƒë·ªãnh n·∫øu c√≥
import { AntdRegistry } from "@ant-design/nextjs-registry";
import AdminLayout from "@/components/AdminLayout"; // Import Layout v√†o
import { ConfigProvider } from "antd";
import { Providers } from "./providers"; // <--- 1. Import Providers

const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: "Phu Bai Production Manager",
  description: "Ph·∫ßn m·ªÅm qu·∫£n l√Ω s·∫£n l∆∞·ª£ng",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="vi">
      <body className={inter.className}>
        <AntdRegistry>
          {/* C·∫•u h√¨nh Theme to√†n c·ª•c ·ªü ƒë√¢y */}
          <ConfigProvider
            theme={{
              token: {
                colorPrimary: "#1677ff",
              },
              components: {
                Layout: {
                  siderBg: "#010345", // (1) M√†u n·ªÅn c·ªßa thanh Sidebar t·ªïng
                },
                Menu: {
                  // M√†u n·ªÅn c·ªßa c√°c m·ª•c menu c·∫•p 1
                  darkItemBg: "#010345",

                  // (2) QUAN TR·ªåNG: M√†u n·ªÅn c·ªßa c√°c menu con (SubMenu) khi x·ªï xu·ªëng
                  darkSubMenuItemBg: "#010345", // <-- B·∫°n ch·ªânh d√≤ng n√†y tr√πng m√†u v·ªõi siderBg l√† ƒë∆∞·ª£c

                  // (3) T√πy ch·ªçn th√™m: M√†u n·ªÅn c·ªßa m·ª•c ƒêANG ƒê∆Ø·ª¢C CH·ªåN (Active)
                  // N√™n ƒë·ªÉ m√†u kh√°c m·ªôt ch√∫t (s√°ng h∆°n ho·∫∑c t·ªëi h∆°n) ƒë·ªÉ ng∆∞·ªùi d√πng bi·∫øt m√¨nh ƒëang ·ªü ƒë√¢u
                  darkItemSelectedBg: "#02A7FA",
                },
              },
            }}
          >
            <Providers>
              <AdminLayout>
                {children}
              </AdminLayout>
            </Providers>
          </ConfigProvider>
        </AntdRegistry>
      </body>
    </html>
  );
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\layout.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\login\page.tsx
================================================================================
"use client";
import React, { useState, useEffect } from "react";
import { Form, Input, Button, Card, Tabs, Select, message } from "antd";
import { UserOutlined, LockOutlined, IdcardOutlined } from "@ant-design/icons";
import { signIn } from "next-auth/react";
import { useRouter } from "next/navigation";

export default function LoginPage() {
    const router = useRouter();
    const [loading, setLoading] = useState(false);
    const [activeTab, setActiveTab] = useState("login");
    const [processes, setProcesses] = useState([]);

    // Load danh s√°ch c√¥ng ƒëo·∫°n ƒë·ªÉ ph·ª•c v·ª• ƒëƒÉng k√Ω
    useEffect(() => {
        fetch("/api/processes").then((res) => res.json()).then(setProcesses);
    }, []);

    const handleLogin = async (values: any) => {
        setLoading(true);
        const res = await signIn("credentials", {
            redirect: false,
            username: values.username,
            password: values.password,
        });
        setLoading(false);

        if (res?.error) {
            message.error(res.error);
        } else {
            message.success("ƒêƒÉng nh·∫≠p th√†nh c√¥ng");
            router.push("/"); // V·ªÅ trang ch·ªß
        }
    };

    const handleRegister = async (values: any) => {
        setLoading(true);
        try {
            const res = await fetch("/api/auth/register", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(values),
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error);

            message.success(data.message);
            setActiveTab("login"); // Chuy·ªÉn v·ªÅ tab login
        } catch (error: any) {
            message.error(error.message);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div style={{ display: "flex", justifyContent: "center", alignItems: "center", height: "100vh", background: "#f0f2f5" }}>
            <Card style={{ width: 400, boxShadow: "0 4px 12px rgba(0,0,0,0.1)" }}>
                <div style={{ textAlign: "center", marginBottom: 20 }}>
                    <h2 style={{ color: "#1890ff" }}>PHU BAI PRODUCTION</h2>
                </div>

                <Tabs activeKey={activeTab} onChange={setActiveTab} centered items={[
                    {
                        key: 'login',
                        label: 'ƒêƒÉng nh·∫≠p',
                        children: (
                            <Form onFinish={handleLogin} layout="vertical">
                                <Form.Item name="username" rules={[{ required: true, message: "Nh·∫≠p username" }]}>
                                    <Input prefix={<UserOutlined />} placeholder="T√™n ƒëƒÉng nh·∫≠p" size="large" />
                                </Form.Item>
                                <Form.Item name="password" rules={[{ required: true, message: "Nh·∫≠p m·∫≠t kh·∫©u" }]}>
                                    <Input.Password prefix={<LockOutlined />} placeholder="M·∫≠t kh·∫©u" size="large" />
                                </Form.Item>
                                <Button type="primary" htmlType="submit" block size="large" loading={loading}>
                                    ƒêƒÇNG NH·∫¨P
                                </Button>
                            </Form>
                        )
                    },
                    {
                        key: 'register',
                        label: 'ƒêƒÉng k√Ω m·ªõi',
                        children: (
                            <Form onFinish={handleRegister} layout="vertical">
                                <Form.Item name="fullName" rules={[{ required: true, message: "Nh·∫≠p h·ªç t√™n" }]}>
                                    <Input prefix={<IdcardOutlined />} placeholder="H·ªç v√† t√™n" />
                                </Form.Item>
                                <Form.Item name="username" rules={[{ required: true }]}>
                                    <Input prefix={<UserOutlined />} placeholder="T√™n ƒëƒÉng nh·∫≠p mu·ªën t·∫°o" />
                                </Form.Item>
                                <Form.Item name="password" rules={[{ required: true }]}>
                                    <Input.Password prefix={<LockOutlined />} placeholder="M·∫≠t kh·∫©u" />
                                </Form.Item>
                                <Form.Item name="processId" label="B·∫°n thu·ªôc b·ªô ph·∫≠n n√†o?" rules={[{ required: true }]}>
                                    <Select placeholder="Ch·ªçn c√¥ng ƒëo·∫°n" options={processes.map((p: any) => ({ label: p.name, value: p.id }))} />
                                </Form.Item>
                                <Button type="primary" htmlType="submit" block loading={loading}>
                                    G·ª¨I Y√äU C·∫¶U ƒêƒÇNG K√ù
                                </Button>
                                <div style={{ marginTop: 10, fontSize: 12, color: '#888', textAlign: 'center' }}>
                                    T√†i kho·∫£n c·∫ßn Admin duy·ªát m·ªõi c√≥ th·ªÉ ƒëƒÉng nh·∫≠p.
                                </div>
                            </Form>
                        )
                    }
                ]} />
            </Card>
        </div>
    );
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\login\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\machines\page.tsx
================================================================================
"use client";

import React, { useEffect, useState } from "react";
import { Table, Card, Button, Input, Select, Tag, Space, Modal, Form, message, InputNumber, Switch, Popconfirm, Row, Col } from "antd";
import { PlusOutlined, EditOutlined, DeleteOutlined, ReloadOutlined, RobotOutlined, ThunderboltOutlined, SearchOutlined } from "@ant-design/icons";
import { useSession } from "next-auth/react";

// ƒê·ªãnh nghƒ©a ki·ªÉu
interface MachineData {
    id: number;
    name: string;
    processId: number;
    process?: { name: string; factory?: { name: string } };
    currentItem?: { name: string; code: string };
    formulaType: number;
    spindleCount?: number;
    isActive: boolean;
}

export default function MachinesPage() {
    const { data: session } = useSession();
    const [machines, setMachines] = useState<MachineData[]>([]);
    const [loading, setLoading] = useState(false);

    // Data danh m·ª•c
    const [factories, setFactories] = useState<any[]>([]);
    const [processes, setProcesses] = useState<any[]>([]);
    const [items, setItems] = useState<any[]>([]);

    // Filter state
    const [filterFactory, setFilterFactory] = useState<number | null>(null);
    const [filterProcess, setFilterProcess] = useState<number | null>(null);
    const [searchText, setSearchText] = useState("");

    // Modal Create/Edit
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [editingMachine, setEditingMachine] = useState<MachineData | null>(null);
    const [form] = Form.useForm();

    // Modal Dispatch (ƒêi·ªÅu ph·ªëi)
    const [isDispatchModalOpen, setIsDispatchModalOpen] = useState(false);
    const [selectedRowKeys, setSelectedRowKeys] = useState<React.Key[]>([]);
    const [dispatchForm] = Form.useForm();

    // 1. Load Data
    const fetchData = async () => {
        setLoading(true);
        try {
            // L·∫•y danh m·ª•c
            const [fRes, pRes, iRes] = await Promise.all([
                fetch('/api/factories'), fetch('/api/processes'), fetch('/api/items')
            ]);
            setFactories(await fRes.json());
            setProcesses(await pRes.json());
            setItems(await iRes.json());

            // L·∫•y Machines
            let query = "?";
            if (filterFactory) query += `factoryId=${filterFactory}&`;
            if (filterProcess) query += `processId=${filterProcess}`;

            const mRes = await fetch(`/api/machines${query}`);
            const mData = await mRes.json();

            // L·ªçc local theo t√™n (n·∫øu c√≥ search text)
            if (searchText) {
                setMachines(mData.filter((m: any) => m.name.toLowerCase().includes(searchText.toLowerCase())));
            } else {
                setMachines(mData);
            }
        } catch (e) { message.error("L·ªói t·∫£i d·ªØ li·ªáu"); }
        finally { setLoading(false); }
    };

    useEffect(() => { fetchData(); }, [filterFactory, filterProcess]); // Reload khi ƒë·ªïi filter

    // 2. X·ª≠ l√Ω Th√™m / S·ª≠a
    const handleSave = async (values: any) => {
        try {
            const url = editingMachine ? `/api/machines/${editingMachine.id}` : "/api/machines";
            const method = editingMachine ? "PUT" : "POST";

            const res = await fetch(url, {
                method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(values)
            });
            if (!res.ok) throw new Error("L·ªói l∆∞u");

            message.success("Th√†nh c√¥ng!");
            setIsModalOpen(false);
            fetchData();
        } catch (e) { message.error("L·ªói khi l∆∞u"); }
    };

    // 3. X·ª≠ l√Ω X√≥a
    const handleDelete = async (id: number) => {
        const res = await fetch(`/api/machines/${id}`, { method: "DELETE" });
        const data = await res.json();
        if (res.ok) { message.success("ƒê√£ x√≥a"); fetchData(); }
        else message.error(data.error);
    };

    // 4. X·ª≠ l√Ω ƒêI·ªÄU PH·ªêI (BATCH ASSIGN)
    const handleDispatch = async (values: any) => {
        try {
            const res = await fetch("/api/machines/batch", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    machineIds: selectedRowKeys,
                    itemId: values.itemId
                })
            });
            if (!res.ok) throw new Error("L·ªói ƒëi·ªÅu ph·ªëi");

            message.success(`ƒê√£ g√°n m·∫∑t h√†ng cho ${selectedRowKeys.length} m√°y!`);
            setIsDispatchModalOpen(false);
            setSelectedRowKeys([]); // Clear selection
            fetchData();
        } catch (e) { message.error("C√≥ l·ªói x·∫£y ra"); }
    };

    // Columns
    const columns = [
        {
            title: "T√™n m√°y", dataIndex: "name", width: 120,
            render: (text: string, r: any) => <b style={{ color: r.isActive ? '#000' : '#ccc' }}>{text} {r.isActive ? '' : '(D·ª´ng)'}</b>
        },
        {
            title: "C√¥ng ƒëo·∫°n", dataIndex: ["process", "name"], width: 150,
            render: (t: string, r: any) => (
                <div>
                    <div style={{ fontSize: 11, color: '#888' }}>{r.process?.factory?.name}</div>
                    <div>{t}</div>
                </div>
            )
        },
        {
            title: "M·∫∑t h√†ng ƒëang ch·∫°y", key: "item",
            render: (_: any, r: MachineData) => r.currentItem ? <Tag color="blue">{r.currentItem.name}</Tag> : <Tag color="red">Ch∆∞a g√°n</Tag>
        },
        {
            title: "C·∫•u h√¨nh", key: "config", responsive: ['lg'] as any,
            render: (_: any, r: MachineData) => (
                <div style={{ fontSize: 12, color: '#666' }}>
                    <div>C√¥ng th·ª©c: Lo·∫°i {r.formulaType}</div>
                    {r.spindleCount && <div>S·ªë c·ªçc: {r.spindleCount}</div>}
                </div>
            )
        },
        {
            title: "H√†nh ƒë·ªông", key: "action", width: 100, align: 'right' as const,
            render: (_: any, r: MachineData) => (
                <Space>
                    <Button size="small" icon={<EditOutlined />} onClick={() => { setEditingMachine(r); form.setFieldsValue(r); setIsModalOpen(true); }} />
                    <Popconfirm title="X√≥a m√°y n√†y?" onConfirm={() => handleDelete(r.id)}>
                        <Button size="small" danger icon={<DeleteOutlined />} />
                    </Popconfirm>
                </Space>
            )
        }
    ];

    // Ch·ªâ Admin/Manager m·ªõi ƒë∆∞·ª£c v√†o
    if (session?.user?.role === "USER") return <div className="p-10">B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y.</div>;

    return (
        <div style={{ padding: 20 }}>
            <Card title={<span><RobotOutlined /> Qu·∫£n l√Ω & ƒêi·ªÅu ph·ªëi M√°y</span>} extra={<Button type="primary" icon={<PlusOutlined />} onClick={() => { setEditingMachine(null); form.resetFields(); setIsModalOpen(true); }}>Th√™m m√°y m·ªõi</Button>}>
                {/* TOOLBAR */}
                <Row gutter={16} style={{ marginBottom: 16 }}>
                    <Col span={6}>
                        <Select
                            style={{ width: '100%' }} placeholder="L·ªçc theo Nh√† m√°y" allowClear
                            options={factories.map(f => ({ label: f.name, value: f.id }))}
                            onChange={setFilterFactory}
                        />
                    </Col>
                    <Col span={6}>
                        <Select
                            style={{ width: '100%' }} placeholder="L·ªçc theo C√¥ng ƒëo·∫°n" allowClear
                            options={processes
                                .filter(p => !filterFactory || p.factoryId === filterFactory)
                                .map(p => ({ label: p.name, value: p.id }))}
                            onChange={setFilterProcess}
                        />
                    </Col>
                    <Col span={6}>
                        <Input placeholder="T√¨m t√™n m√°y..." prefix={<SearchOutlined />} onChange={e => setSearchText(e.target.value)} />
                    </Col>
                    <Col span={6} style={{ textAlign: 'right' }}>
                        <Button icon={<ReloadOutlined />} onClick={fetchData}>T·∫£i l·∫°i</Button>
                    </Col>
                </Row>

                {/* THANH ƒêI·ªÄU PH·ªêI (Hi·ªán ra khi ch·ªçn d√≤ng) */}
                {selectedRowKeys.length > 0 && (
                    <div style={{ marginBottom: 16, background: '#e6f7ff', padding: '10px 20px', borderRadius: 6, border: '1px solid #91d5ff', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <span style={{ color: '#1890ff' }}><b>ƒê√£ ch·ªçn {selectedRowKeys.length} m√°y</b>. B·∫°n mu·ªën l√†m g√¨?</span>
                        <Button type="primary" icon={<ThunderboltOutlined />} onClick={() => setIsDispatchModalOpen(true)}>
                            ƒêi·ªÅu ph·ªëi (G√°n m·∫∑t h√†ng lo·∫°t)
                        </Button>
                    </div>
                )}

                <Table
                    rowKey="id"
                    columns={columns}
                    dataSource={machines}
                    loading={loading}
                    rowSelection={{
                        selectedRowKeys,
                        onChange: setSelectedRowKeys
                    }}
                    pagination={{ pageSize: 20 }}
                />
            </Card>

            {/* MODAL 1: CREATE / EDIT MACHINE */}
            <Modal
                title={editingMachine ? "C·∫≠p nh·∫≠t m√°y" : "Th√™m m√°y m·ªõi"}
                open={isModalOpen}
                onCancel={() => setIsModalOpen(false)}
                footer={null}
            >
                <Form form={form} layout="vertical" onFinish={handleSave}>
                    <Form.Item name="name" label="T√™n m√°y" rules={[{ required: true }]}>
                        <Input placeholder="V√≠ d·ª•: M√°y 01" />
                    </Form.Item>

                    <Form.Item name="processId" label="Thu·ªôc C√¥ng ƒëo·∫°n" rules={[{ required: true }]}>
                        <Select options={processes.map(p => ({ label: `${p.name} (${p.factory?.name})`, value: p.id }))} />
                    </Form.Item>

                    <Row gutter={16}>
                        <Col span={12}>
                            <Form.Item name="formulaType" label="C√¥ng th·ª©c t√≠nh" rules={[{ required: true }]}>
                                <Select options={[
                                    { label: 'Lo·∫°i 1: S·∫£n l∆∞·ª£ng tr·ª±c ti·∫øp', value: 1 },
                                    { label: 'Lo·∫°i 2: Tr·ª´ l√πi (Cu·ªëi - ƒê·∫ßu)', value: 2 },
                                    { label: 'Lo·∫°i 3: D√†nh cho m√°y Th√¥', value: 3 },
                                    { label: 'Lo·∫°i 4: (Cu·ªëi - ƒê·∫ßu) / Chi s·ªë', value: 4 },
                                ]} />
                            </Form.Item>
                        </Col>
                        <Col span={12}>
                            <Form.Item name="spindleCount" label="S·ªë c·ªçc (N·∫øu c√≥)">
                                <InputNumber style={{ width: '100%' }} />
                            </Form.Item>
                        </Col>
                    </Row>

                    <Form.Item name="isActive" valuePropName="checked" label="Tr·∫°ng th√°i">
                        <Switch checkedChildren="Ho·∫°t ƒë·ªông" unCheckedChildren="T·∫°m d·ª´ng" defaultChecked />
                    </Form.Item>

                    <Button type="primary" htmlType="submit" block>L∆∞u th√¥ng tin</Button>
                </Form>
            </Modal>

            {/* MODAL 2: DISPATCH (ƒêI·ªÄU PH·ªêI) */}
            <Modal
                title={<span><ThunderboltOutlined /> ƒêi·ªÅu ph·ªëi s·∫£n xu·∫•t</span>}
                open={isDispatchModalOpen}
                onCancel={() => setIsDispatchModalOpen(false)}
                footer={null}
            >
                <div style={{ marginBottom: 16 }}>
                    B·∫°n ƒëang th·ª±c hi·ªán ƒë·ªïi m·∫∑t h√†ng cho <b>{selectedRowKeys.length} m√°y</b> ƒë√£ ch·ªçn.
                    <br />D·ªØ li·ªáu Chi s·ªë (NE) c·ªßa m√°y s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t theo m·∫∑t h√†ng m·ªõi.
                </div>
                <Form form={dispatchForm} layout="vertical" onFinish={handleDispatch}>
                    <Form.Item name="itemId" label="Ch·ªçn m·∫∑t h√†ng mu·ªën ch·∫°y:" rules={[{ required: true, message: 'Vui l√≤ng ch·ªçn h√†ng' }]}>
                        <Select
                            showSearch
                            optionFilterProp="label"
                            placeholder="T√¨m t√™n m·∫∑t h√†ng..."
                            options={items.map(i => ({ label: `${i.name} (NE: ${i.ne})`, value: i.id }))}
                        />
                    </Form.Item>
                    <Button type="primary" htmlType="submit" block size="large">X√°c nh·∫≠n chuy·ªÉn ƒë·ªïi</Button>
                </Form>
            </Modal>
        </div>
    );
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\machines\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\page.tsx
================================================================================
import Image from "next/image";

export default function Home() {
  return (
    <div>
      <h1>Welcome to NEXTJS App.</h1>
      <Image src="/nextjs-logo.png" alt="Logo" width={301} height={168}></Image>
    </div>
  );
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\processes\page.tsx
================================================================================
"use client";

import React, { useEffect, useState } from "react";
import {
  Table,
  Button,
  Modal,
  Form,
  Input,
  message,
  Space,
  Card,
  Select,
  Tag,
} from "antd";
import {
  PlusOutlined,
  EditOutlined,
  DeleteOutlined,
  FilterOutlined,
} from "@ant-design/icons";

// ƒê·ªãnh nghƒ©a ki·ªÉu d·ªØ li·ªáu
interface Factory {
  id: number;
  name: string;
}

interface Process {
  id: number;
  name: string;
  factoryId: number;
  factory?: Factory; // D·ªØ li·ªáu quan h·ªá
}

export default function ProcessPage() {
  // --- STATE ---
  const [processes, setProcesses] = useState<Process[]>([]); // D·ªØ li·ªáu g·ªëc
  const [filteredProcesses, setFilteredProcesses] = useState<Process[]>([]); // D·ªØ li·ªáu hi·ªÉn th·ªã (sau khi l·ªçc)
  const [factories, setFactories] = useState<Factory[]>([]); // Danh s√°ch nh√† m√°y cho Dropdown

  const [loading, setLoading] = useState(false);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingProcess, setEditingProcess] = useState<Process | null>(null);
  const [filterFactoryId, setFilterFactoryId] = useState<number | null>(null); // State l∆∞u nh√† m√°y ƒëang l·ªçc

  const [form] = Form.useForm();
  // --- 1. FETCH DATA (G·ªçi c·∫£ 2 API) ---
  const fetchData = async () => {
    setLoading(true);
    try {
      // G·ªçi song song 2 API cho nhanh
      const [resFactories, resProcesses] = await Promise.all([
        fetch("/api/factories"),
        fetch("/api/processes"),
      ]);

      const factoriesData = await resFactories.json();
      const processesData = await resProcesses.json();

      setFactories(factoriesData);
      setProcesses(processesData);
      setFilteredProcesses(processesData); // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã h·∫øt
    } catch (error) {
      message.error("L·ªói t·∫£i d·ªØ li·ªáu");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchData();
  }, []);

  // --- 2. LOGIC L·ªåC (Khi ch·ªçn Dropdown Nh√† m√°y ·ªü tr√™n c√πng) ---
  useEffect(() => {
    if (filterFactoryId === null) {
      setFilteredProcesses(processes); // N·∫øu ch·ªçn "T·∫•t c·∫£" -> Hi·ªán h·∫øt
    } else {
      // L·ªçc c√°c c√¥ng ƒëo·∫°n thu·ªôc nh√† m√°y ƒë√£ ch·ªçn
      const result = processes.filter((p) => p.factoryId === filterFactoryId);
      setFilteredProcesses(result);
    }
  }, [filterFactoryId, processes]);

  // --- 3. X·ª¨ L√ù L∆ØU (TH√äM/S·ª¨A) ---
  const handleSave = async (values: any) => {
    try {
      let res;
      const payload = { ...values }; // { name: '...', factoryId: ... }

      if (editingProcess) {
        // Update
        res = await fetch(`/api/processes/${editingProcess.id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
      } else {
        // Create
        res = await fetch("/api/processes", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
      }

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error);
      }

      message.success(
        editingProcess ? "C·∫≠p nh·∫≠t th√†nh c√¥ng" : "Th√™m m·ªõi th√†nh c√¥ng"
      );
      setIsModalOpen(false);
      form.resetFields();
      setEditingProcess(null);
      fetchData(); // Load l·∫°i d·ªØ li·ªáu m·ªõi nh·∫•t
    } catch (error: any) {
      message.error(error.message || "C√≥ l·ªói x·∫£y ra");
    }
  };

  // --- 4. X·ª¨ L√ù X√ìA ---
  const handleDelete = (id: number) => {
    Modal.confirm({
      title: "C·∫£nh b√°o x√≥a",
      content: "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√¥ng ƒëo·∫°n n√†y?",
      onOk: async () => {
        try {
          const res = await fetch(`/api/processes/${id}`, { method: "DELETE" });
          if (!res.ok) throw new Error("Kh√¥ng th·ªÉ x√≥a");
          message.success("ƒê√£ x√≥a");
          fetchData();
        } catch (error) {
          message.error("L·ªói: Kh√¥ng th·ªÉ x√≥a (C√≥ th·ªÉ ƒëang ch·ª©a m√°y m√≥c)");
        }
      },
    });
  };

  // --- 5. C·∫§U H√åNH C·ªòT B·∫¢NG ---
  const columns = [
    { title: "ID", dataIndex: "id", width: 60 },
    {
      title: "T√™n C√¥ng ƒêo·∫°n",
      dataIndex: "name",
      render: (text: string) => <b>{text}</b>,
    },
    {
      title: "Thu·ªôc Nh√† M√°y",
      dataIndex: "factory",
      render: (factory: Factory) => (
        // Hi·ªÉn th·ªã t√™n nh√† m√°y d∆∞·ªõi d·∫°ng th·∫ª m√†u cho ƒë·∫πp
        <Tag color="blue">{factory?.name || "N/A"}</Tag>
      ),
    },
    {
      title: "H√†nh ƒë·ªông",
      key: "action",
      width: 120,
      render: (_: any, record: Process) => (
        <Space>
          <Button
            icon={<EditOutlined />}
            size="small"
            onClick={() => {
              setEditingProcess(record);
              form.setFieldsValue({
                name: record.name,
                factoryId: record.factoryId, // ƒêi·ªÅn ID nh√† m√°y v√†o dropdown
              });
              setIsModalOpen(true);
            }}
          />
          <Button
            icon={<DeleteOutlined />}
            danger
            size="small"
            onClick={() => handleDelete(record.id)}
          />
        </Space>
      ),
    },
  ];

  return (
    <div style={{ padding: 20 }}>
      <Card
        title="Qu·∫£n l√Ω C√¥ng ƒêo·∫°n S·∫£n Xu·∫•t"
        extra={
          <Button
            type="primary"
            icon={<PlusOutlined />}
            onClick={() => {
              setEditingProcess(null);
              form.resetFields();
              // N·∫øu ƒëang l·ªçc theo nh√† m√°y n√†o, t·ª± ƒë·ªông ƒëi·ªÅn nh√† m√°y ƒë√≥ v√†o form th√™m m·ªõi lu√¥n (UX t·ªët)
              if (filterFactoryId) {
                form.setFieldValue("factoryId", filterFactoryId);
              }
              setIsModalOpen(true);
            }}
          >
            Th√™m C√¥ng ƒêo·∫°n
          </Button>
        }
      >
        {/* --- THANH C√îNG C·ª§ L·ªåC --- */}
        <div
          style={{
            marginBottom: 16,
            display: "flex",
            alignItems: "center",
            gap: 10,
          }}
        >
          <FilterOutlined />
          <span style={{ fontWeight: 500 }}>L·ªçc theo nh√† m√°y:</span>
          <Select
            style={{ width: 200 }}
            placeholder="Ch·ªçn nh√† m√°y..."
            allowClear
            onChange={(value) => setFilterFactoryId(value)}
            options={factories.map((f) => ({ label: f.name, value: f.id }))}
          />
        </div>

        {/* --- B·∫¢NG D·ªÆ LI·ªÜU --- */}
        <Table
          rowKey="id"
          columns={columns}
          dataSource={filteredProcesses} // D√πng d·ªØ li·ªáu ƒë√£ l·ªçc
          loading={loading}
          bordered
          pagination={{ pageSize: 10 }}
        />
      </Card>

      {/* --- MODAL FORM --- */}
      <Modal
        title={editingProcess ? "S·ª≠a C√¥ng ƒêo·∫°n" : "Th√™m C√¥ng ƒêo·∫°n"}
        open={isModalOpen}
        onCancel={() => setIsModalOpen(false)}
        footer={null}
      >
        <Form form={form} layout="vertical" onFinish={handleSave}>
          <Form.Item
            name="factoryId"
            label="Thu·ªôc Nh√† M√°y"
            rules={[{ required: true, message: "Vui l√≤ng ch·ªçn nh√† m√°y!" }]}
          >
            <Select
              placeholder="Ch·ªçn nh√† m√°y"
              options={factories.map((f) => ({ label: f.name, value: f.id }))}
            />
          </Form.Item>

          <Form.Item
            name="name"
            label="T√™n C√¥ng ƒêo·∫°n"
            rules={[{ required: true, message: "Nh·∫≠p t√™n c√¥ng ƒëo·∫°n!" }]}
          >
            <Input placeholder="V√≠ d·ª•: B√¥ng ch·∫£i, Gh√©p th√¥..." />
          </Form.Item>

          <div style={{ textAlign: "right", marginTop: 20 }}>
            <Space>
              <Button onClick={() => setIsModalOpen(false)}>H·ªßy</Button>
              <Button type="primary" htmlType="submit">
                {editingProcess ? "C·∫≠p Nh·∫≠t" : "L∆∞u L·∫°i"}
              </Button>
            </Space>
          </div>
        </Form>
      </Modal>
    </div>
  );
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\processes\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\production\daily-input\page.tsx
================================================================================
"use client";

import React, { useEffect, useState, useMemo, useRef } from 'react';
import { Card, Select, DatePicker, Button, Row, Col, Modal, Form, InputNumber, Switch, message, Tag, Statistic, Input } from 'antd';
import { SaveOutlined, ArrowRightOutlined } from '@ant-design/icons';
import dayjs from 'dayjs';
import type { Dayjs } from 'dayjs';
import { useSession } from "next-auth/react"; // 1. IMPORT SESSION

interface Machine {
    id: number;
    name: string;
    formulaType: number;
    processId: number;
    spindleCount?: number;
    currentItem?: { id: number; name: string };
    currentNE?: number;
    todayLog?: { id: number; finalOutput: number };
}

interface Factory { id: number; name: string; }
interface Process { id: number; name: string; factoryId: number; }

export default function DailyInputPage() {
    // 2. L·∫§Y TH√îNG TIN USER
    const { data: session } = useSession();

    // --- STATE ---
    const [selectedDate, setSelectedDate] = useState<Dayjs>(dayjs());
    const [selectedShift, setSelectedShift] = useState<number>(1);
    const [selectedFactoryId, setSelectedFactoryId] = useState<number | null>(null);
    const [selectedProcessId, setSelectedProcessId] = useState<number | null>(null);

    const [machines, setMachines] = useState<Machine[]>([]);
    const [factories, setFactories] = useState<Factory[]>([]);
    const [processes, setProcesses] = useState<Process[]>([]);
    const [loading, setLoading] = useState(false);

    // Modal & Form
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [currentMachine, setCurrentMachine] = useState<Machine | null>(null);
    const [form] = Form.useForm();
    const inputRef = useRef<any>(null);

    const watchEndIndex = Form.useWatch('endIndex', form);
    const watchStartIndex = Form.useWatch('startIndex', form);
    const watchIsReset = Form.useWatch('isReset', form);
    const watchIsStopped = Form.useWatch('isStopped', form);
    const watchInputNE = Form.useWatch('inputNE', form);

    // --- LOGIC CH·ªåN CA & NG√ÄY ---
    useEffect(() => {
        const now = dayjs();
        const hour = now.hour();

        if (hour >= 13 && hour < 21) {
            setSelectedShift(1);
            setSelectedDate(now);
        } else if (hour >= 21) {
            setSelectedShift(2);
            setSelectedDate(now);
        } else if (hour >= 0 && hour < 5) {
            setSelectedShift(2);
            setSelectedDate(now.subtract(1, 'day'));
        } else if (hour >= 5 && hour < 13) {
            setSelectedShift(3);
            setSelectedDate(now.subtract(1, 'day'));
        }

        fetchMetadata();
    }, []);

    const fetchMetadata = async () => {
        try {
            const [resFac, resPro] = await Promise.all([fetch('/api/factories'), fetch('/api/processes')]);
            if (resFac.ok && resPro.ok) {
                setFactories(await resFac.json());
                setProcesses(await resPro.json());
            }
        } catch (e) { message.error("L·ªói t·∫£i danh m·ª•c"); }
    };

    // --- 3. LOGIC T·ª∞ ƒê·ªòNG CH·ªåN NH√Ä M√ÅY & C√îNG ƒêO·∫†N THEO USER ---
    useEffect(() => {
        // Ch·ªâ ch·∫°y khi ƒë√£ t·∫£i xong danh m·ª•c V√Ä ƒë√£ c√≥ session
        if (processes.length > 0 && session?.user?.processId) {
            const userProcessId = Number(session.user.processId);

            // T√¨m c√¥ng ƒëo·∫°n c·ªßa user trong danh s√°ch
            const targetProcess = processes.find(p => p.id === userProcessId);

            if (targetProcess) {
                // T·ª± ƒë·ªông set Factory tr∆∞·ªõc
                setSelectedFactoryId(targetProcess.factoryId);
                // Sau ƒë√≥ set Process
                setSelectedProcessId(targetProcess.id);
            }
        }
    }, [processes, session]); // Ch·∫°y l·∫°i khi processes ho·∫∑c session thay ƒë·ªïi

    // --- T·∫¢I M√ÅY ---
    const fetchMachines = async () => {
        if (!selectedProcessId) return;
        setLoading(true);
        try {
            const dateStr = selectedDate.format('YYYY-MM-DD');
            const query = `?processId=${selectedProcessId}&date=${dateStr}&shift=${selectedShift}`;
            const res = await fetch(`/api/production/daily-status${query}`);
            const data = await res.json();
            setMachines(data);
        } catch (error) {
            message.error("L·ªói t·∫£i m√°y");
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => { fetchMachines(); }, [selectedProcessId, selectedDate, selectedShift]);

    // --- C√ÅC H√ÄM X·ª¨ L√ù KH√ÅC GI·ªÆ NGUY√äN ---
    const handleOpenMachine = async (machine: Machine) => {
        if (!machine.currentItem) {
            message.warning(`M√°y ${machine.name} ch∆∞a g√°n m·∫∑t h√†ng!`);
            return;
        }
        setCurrentMachine(machine);
        form.resetFields();

        const initValues: any = {
            isReset: false,
            isStopped: false,
            inputNE: machine.currentNE || 30,
            itemId: machine.currentItem?.id,
            startIndex: 0,
            endIndex: null
        };

        if (machine.todayLog) {
            message.info("M√°y n√†y ƒë√£ nh·∫≠p li·ªáu r·ªìi.");
        } else {
            try {
                const res = await fetch(`/api/production/last-log?machineId=${machine.id}&date=${selectedDate.format('YYYY-MM-DD')}&shift=${selectedShift}`);
                const lastLog = await res.json();
                if (lastLog && lastLog.endIndex !== undefined) {
                    initValues.startIndex = lastLog.endIndex;
                } else {
                    initValues.isNewMachine = true;
                }
            } catch (e) { console.error(e); }
        }
        form.setFieldsValue(initValues);
        setIsModalOpen(true);
        setTimeout(() => inputRef.current?.focus(), 100);
    };

    const calculatedOutput = useMemo(() => {
        if (!currentMachine || watchIsStopped) return 0;
        const start = Number(watchStartIndex) || 0;
        const end = Number(watchEndIndex);
        if (watchEndIndex === null || watchEndIndex === undefined) return 0;

        const delta = watchIsReset ? end : end - start;
        const type = currentMachine.formulaType;
        let result = 0;

        if (type === 1) result = end;
        else if (type === 2) result = delta;
        else if (type === 3) {
            const ne = Number(watchInputNE) || 1;
            const spindles = currentMachine.spindleCount || 1;
            const denominator = ne * 1000 * 1.693;
            if (denominator !== 0) result = (delta * spindles) / denominator;
        } else if (type === 4) {
            const ne = Number(watchInputNE) || 1;
            if (ne !== 0) result = delta / ne;
        }
        return parseFloat(result.toFixed(2));
    }, [watchEndIndex, watchStartIndex, watchIsReset, watchIsStopped, watchInputNE, currentMachine]);

    const handleSave = async (saveAndNext: boolean) => {
        try {
            const values = await form.validateFields();
            if (calculatedOutput < 0 && !values.isReset && !values.isStopped) {
                Modal.error({ title: 'L·ªói s·ªë li·ªáu!', content: 'S·∫£n l∆∞·ª£ng b·ªã √ÇM. C√≥ ph·∫£i ƒë·ªìng h·ªì ƒë√£ b·ªã Reset v·ªÅ 0? H√£y t√≠ch v√†o √¥ "ƒê√£ Reset".' });
                return;
            }
            if (calculatedOutput > 1000) {
                Modal.confirm({
                    title: 'C·∫£nh b√°o s·ªë li·ªáu l·ªõn',
                    content: `S·∫£n l∆∞·ª£ng ${calculatedOutput} kg l√† r·∫•t l·ªõn. B·∫°n c√≥ ch·∫Øc ch·∫Øn nh·∫≠p ƒë√∫ng kh√¥ng?`,
                    onOk: () => submitData(values, saveAndNext),
                });
                return;
            }
            await submitData(values, saveAndNext);
        } catch (e) { }
    };

    const submitData = async (values: any, saveAndNext: boolean) => {
        try {
            const payload = {
                recordDate: selectedDate.format('YYYY-MM-DD'),
                shift: selectedShift,
                machineId: currentMachine?.id,
                itemId: values.itemId,
                startIndex: values.startIndex,
                endIndex: values.endIndex,
                inputNE: values.inputNE,
                finalOutput: calculatedOutput,
                note: values.isStopped ? "M√°y d·ª´ng" : (values.isReset ? "Reset ƒë·ªìng h·ªì" : "")
            };
            const res = await fetch('/api/production/daily-input', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error('L·ªói l∆∞u');
            message.success("ƒê√£ l∆∞u th√†nh c√¥ng!");
            setMachines(prev => prev.map(m => m.id === currentMachine?.id ? { ...m, todayLog: { id: 0, finalOutput: calculatedOutput } } : m));

            if (saveAndNext) {
                const idx = machines.findIndex(m => m.id === currentMachine?.id);
                if (idx < machines.length - 1) handleOpenMachine(machines[idx + 1]);
                else { setIsModalOpen(false); message.success("ƒê√£ nh·∫≠p h·∫øt danh s√°ch!"); }
            } else { setIsModalOpen(false); }
        } catch (e) { message.error("L·ªói khi l∆∞u d·ªØ li·ªáu"); }
    };

    // 1. X√°c ƒë·ªãnh xem c√≥ n√™n kh√≥a hay kh√¥ng?
    const isRestrictedUser = session?.user?.role !== "ADMIN" && !!session?.user?.processId;

    // --- GIAO DI·ªÜN ---
    return (
        <div style={{ padding: 20 }}>
            <Card style={{ marginBottom: 16 }} size="small">
                <Row gutter={16} align="middle">
                    <Col span={8}>
                        <div style={{ fontWeight: 500, marginBottom: 4 }}>Nh√† m√°y & C√¥ng ƒëo·∫°n:</div>
                        <div style={{ display: 'flex', gap: 8 }}>
                            <Select
                                style={{ width: '50%' }}
                                placeholder="Ch·ªçn Nh√† m√°y"
                                options={factories.map(f => ({ label: f.name, value: f.id }))}
                                onChange={val => { setSelectedFactoryId(val); setSelectedProcessId(null); }}
                                value={selectedFactoryId}
                                // KH√ìA NH√Ä M√ÅY N·∫æU USER B·ªä GI·ªöI H·∫†N
                                disabled={isRestrictedUser}
                            />
                            <Select
                                style={{ width: '50%' }}
                                placeholder="Ch·ªçn C√¥ng ƒëo·∫°n"
                                options={processes.filter(p => p.factoryId === selectedFactoryId).map(p => ({ label: p.name, value: p.id }))}
                                onChange={setSelectedProcessId}
                                // KH√ìA C√îNG ƒêO·∫†N N·∫æU USER B·ªä GI·ªöI H·∫†N (Ho·∫∑c ch∆∞a ch·ªçn nh√† m√°y)
                                disabled={!selectedFactoryId || isRestrictedUser}
                            />
                        </div>
                    </Col>
                    <Col span={8}>
                        <div style={{ fontWeight: 500, marginBottom: 4 }}>Ng√†y & Ca s·∫£n xu·∫•t:</div>
                        <div style={{ display: 'flex', gap: 8 }}>
                            <DatePicker value={selectedDate} onChange={val => val && setSelectedDate(val)} format="DD/MM/YYYY" allowClear={false} style={{ flex: 1 }} />
                            <Select value={selectedShift} onChange={setSelectedShift} style={{ width: 100 }} options={[{ label: 'Ca 1', value: 1 }, { label: 'Ca 2', value: 2 }, { label: 'Ca 3', value: 3 }]} />
                        </div>
                    </Col>
                    <Col span={8} style={{ textAlign: 'right' }}>
                        <Statistic title="Ti·∫øn ƒë·ªô nh·∫≠p li·ªáu" value={machines.filter(m => m.todayLog).length} suffix={`/ ${machines.length} m√°y`} valueStyle={{ fontSize: 20, color: '#1890ff' }} />
                    </Col>
                </Row>
            </Card>

            {!selectedProcessId ? (
                <div style={{ textAlign: 'center', padding: 50, background: '#fff', borderRadius: 8 }}>
                    <div style={{ color: '#999', marginBottom: 10 }}>Vui l√≤ng ch·ªçn <b>Nh√† m√°y</b> v√† <b>C√¥ng ƒëo·∫°n</b> ƒë·ªÉ hi·ªÉn th·ªã danh s√°ch m√°y.</div>
                </div>
            ) : (
                <Row gutter={[12, 12]}>
                    {machines.length === 0 && <div style={{ width: '100%', textAlign: 'center', padding: 20 }}>Kh√¥ng c√≥ m√°y n√†o trong c√¥ng ƒëo·∫°n n√†y.</div>}
                    {machines.map(m => {
                        const isDone = !!m.todayLog;
                        return (
                            <Col key={m.id} xs={12} sm={8} md={6} lg={4}>
                                <Card hoverable onClick={() => handleOpenMachine(m)} style={{ cursor: 'pointer', border: isDone ? '2px solid #52c41a' : '1px solid #d9d9d9', background: isDone ? '#f6ffed' : '#fff' }} bodyStyle={{ padding: 12 }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                        <b>{m.name}</b>
                                        {isDone && <SaveOutlined style={{ color: '#52c41a' }} />}
                                    </div>
                                    <div style={{ fontSize: 12, color: '#666', marginTop: 4 }}>
                                        {m.currentItem?.name || <span style={{ color: 'red' }}>Ch∆∞a g√°n h√†ng</span>}
                                    </div>
                                    <div style={{ marginTop: 8, textAlign: 'right', fontWeight: 'bold', fontSize: 16 }}>
                                        {isDone ? <span style={{ color: 'green' }}>{m.todayLog?.finalOutput} <small>kg</small></span> : <span style={{ color: '#ccc' }}>--</span>}
                                    </div>
                                </Card>
                            </Col>
                        )
                    })}
                </Row>
            )}

            <Modal open={isModalOpen} onCancel={() => setIsModalOpen(false)} footer={null} width={500} centered title={<span>{currentMachine?.name} <Tag color="blue">{currentMachine?.currentItem?.name}</Tag></span>}>
                <Form form={form} layout="vertical">
                    <Form.Item name="itemId" hidden><Input /></Form.Item>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 16, background: '#f5f5f5', padding: 10, borderRadius: 6 }}>
                        <Form.Item name="isStopped" valuePropName="checked" noStyle><Switch checkedChildren="M√°y d·ª´ng" unCheckedChildren="M√°y ƒëang ch·∫°y" /></Form.Item>
                        <Form.Item name="isReset" valuePropName="checked" noStyle><Switch checkedChildren="ƒê√£ Reset" unCheckedChildren="B√¨nh th∆∞·ªùng" disabled={watchIsStopped} style={{ background: watchIsReset ? '#faad14' : undefined }} /></Form.Item>
                    </div>
                    <Row gutter={16}>
                        <Col span={12}>
                            <Form.Item name="startIndex" label="Ch·ªâ s·ªë TR∆Ø·ªöC">
                                <InputNumber style={{ width: '100%' }} readOnly={!watchIsReset && !form.getFieldValue('isNewMachine')} variant="filled" disabled={watchIsStopped} />
                            </Form.Item>
                        </Col>
                        <Col span={12}>
                            <Form.Item name="endIndex" label="Ch·ªâ s·ªë SAU" rules={[{ required: !watchIsStopped, message: 'Nh·∫≠p ch·ªâ s·ªë!' }]}>
                                <InputNumber ref={inputRef} style={{ width: '100%', fontWeight: 'bold', fontSize: 16 }} onPressEnter={() => handleSave(true)} disabled={watchIsStopped} />
                            </Form.Item>
                        </Col>
                    </Row>
                    {(currentMachine?.formulaType === 3 || currentMachine?.formulaType === 4) && (
                        <Form.Item name="inputNE" label="Chi s·ªë (NE) th·ª±c t·∫ø">
                            <InputNumber style={{ width: '100%' }} disabled={watchIsStopped} />
                        </Form.Item>
                    )}
                    <div style={{ textAlign: 'center', padding: 15, background: calculatedOutput < 0 ? '#fff1f0' : '#f6ffed', marginBottom: 20, borderRadius: 8, border: calculatedOutput < 0 ? '1px solid #ffccc7' : '1px solid #b7eb8f' }}>
                        <div style={{ color: '#666', fontSize: 12 }}>S·∫£n l∆∞·ª£ng ∆∞·ªõc t√≠nh:</div>
                        <div style={{ fontSize: 28, fontWeight: 'bold', color: calculatedOutput < 0 ? 'red' : '#389e0d' }}>
                            {calculatedOutput} <small>kg</small>
                        </div>
                    </div>
                    <Row gutter={16}>
                        <Col span={8}><Button block onClick={() => setIsModalOpen(false)}>H·ªßy</Button></Col>
                        <Col span={8}><Button block icon={<SaveOutlined />} onClick={() => handleSave(false)} disabled={!watchIsStopped && calculatedOutput < 0}>L∆∞u</Button></Col>
                        <Col span={8}><Button block type="primary" icon={<ArrowRightOutlined />} onClick={() => handleSave(true)} disabled={!watchIsStopped && calculatedOutput < 0}>L∆∞u & Ti·∫øp</Button></Col>
                    </Row>
                </Form>
            </Modal>
        </div>
    );
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\production\daily-input\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\production\history\page.tsx
================================================================================
"use client";

import React, { useState, useEffect, useMemo } from "react";
import { Card, DatePicker, Select, Button, Table, Tag, Row, Col, Statistic, Space, message, Divider } from "antd";
import { SearchOutlined, FileExcelOutlined, ReloadOutlined, FilterOutlined, BarChartOutlined } from "@ant-design/icons";
import dayjs from "dayjs";
import * as XLSX from "xlsx";
// Th∆∞ vi·ªán bi·ªÉu ƒë·ªì
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip as RechartsTooltip, ResponsiveContainer, Cell } from 'recharts';

const { RangePicker } = DatePicker;

export default function ProductionHistoryPage() {
    // --- 1. STATE D·ªÆ LI·ªÜU ---
    const [logs, setLogs] = useState<any[]>([]);
    const [loading, setLoading] = useState(false);

    // State Ph√¢n trang & Th·ªëng k√™ Server tr·∫£ v·ªÅ
    const [pagination, setPagination] = useState({ current: 1, pageSize: 20, total: 0 });
    const [serverStats, setServerStats] = useState({ totalOutput: 0 });

    // --- 2. STATE DANH M·ª§C (ƒê·ªÉ ƒë·ªï v√†o √¥ l·ªçc) ---
    const [factories, setFactories] = useState<any[]>([]);
    const [processes, setProcesses] = useState<any[]>([]);
    const [machines, setMachines] = useState<any[]>([]);
    const [items, setItems] = useState<any[]>([]);

    // --- 3. STATE B·ªò L·ªåC ---
    const [dateRange, setDateRange] = useState<[dayjs.Dayjs, dayjs.Dayjs]>([dayjs().subtract(7, 'day'), dayjs()]);
    const [selectedFactories, setSelectedFactories] = useState<number[]>([]);
    const [selectedProcesses, setSelectedProcesses] = useState<number[]>([]);
    const [selectedMachines, setSelectedMachines] = useState<number[]>([]);
    const [selectedShifts, setSelectedShifts] = useState<number[]>([]);
    const [selectedItems, setSelectedItems] = useState<number[]>([]);

    // --- 4. LOAD DANH M·ª§C L√öC ƒê·∫¶U ---
    useEffect(() => {
        const fetchData = async () => {
            try {
                const [f, p, m, i] = await Promise.all([
                    fetch("/api/factories").then(r => r.json()),
                    fetch("/api/processes").then(r => r.json()),
                    // T·∫°m d√πng endpoint backup ƒë·ªÉ l·∫•y list m√°y, ho·∫∑c b·∫°n c√≥ th·ªÉ t·∫°o endpoint /api/machines ri√™ng
                    fetch("/api/admin/backup").then(r => r.json().then(d => d.data.machines || [])),
                    fetch("/api/items").then(r => r.json())
                ]);
                setFactories(f); setProcesses(p); setMachines(m); setItems(i);
            } catch (e) { console.error(e); }
        };
        fetchData();
        // Load d·ªØ li·ªáu m·∫∑c ƒë·ªãnh trang 1
        handleSearch(1);
    }, []);

    // --- 5. H√ÄM T√åM KI·∫æM (G·ªåI API) ---
    const handleSearch = async (pageIndex = 1) => {
        setLoading(true);
        try {
            const payload = {
                fromDate: dateRange[0].format("YYYY-MM-DD"),
                toDate: dateRange[1].format("YYYY-MM-DD"),
                factoryIds: selectedFactories,
                processIds: selectedProcesses,
                machineIds: selectedMachines,
                shifts: selectedShifts,
                itemIds: selectedItems,
                page: pageIndex,
                pageSize: pagination.pageSize
            };

            const res = await fetch("/api/production/history", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const responseData = await res.json();

            if (responseData.error) throw new Error(responseData.error);

            // C·∫≠p nh·∫≠t State
            setLogs(responseData.data);
            setPagination({
                current: responseData.pagination.current,
                pageSize: responseData.pagination.pageSize,
                total: responseData.pagination.total
            });
            setServerStats({ totalOutput: responseData.stats.totalOutput });

        } catch (error) {
            message.error("L·ªói t·∫£i d·ªØ li·ªáu");
        } finally {
            setLoading(false);
        }
    };

    // --- 6. X·ª¨ L√ù CHUY·ªÇN TRANG ---
    const handleTableChange = (newPagination: any) => {
        handleSearch(newPagination.current);
    };

    // --- 7. T√çNH TO√ÅN BI·ªÇU ƒê·ªí (D·ª±a tr√™n d·ªØ li·ªáu trang hi·ªán t·∫°i) ---
    // L∆∞u √Ω: ƒê·ªÉ bi·ªÉu ƒë·ªì ch√≠nh x√°c tuy·ªát ƒë·ªëi cho to√†n b·ªô d·ªØ li·ªáu l·ªõn, c·∫ßn API ri√™ng. 
    // ·ªû ƒë√¢y ta v·∫Ω bi·ªÉu ƒë·ªì d·ª±a tr√™n 20-50 d√≤ng d·ªØ li·ªáu ƒëang hi·ªÉn th·ªã ƒë·ªÉ user c√≥ c√°i nh√¨n nhanh.
    const chartData = useMemo(() => {
        const map: any = {};
        logs.forEach(log => {
            const name = log.machine?.process?.name || "Kh√°c";
            map[name] = (map[name] || 0) + log.finalOutput;
        });
        return Object.keys(map).map(name => ({ name, output: map[name] }));
    }, [logs]);

    // --- 8. XU·∫§T EXCEL ---
    const exportToExcel = () => {
        const dataToExport = logs.map(log => ({
            "Ng√†y": dayjs(log.recordDate).format("DD/MM/YYYY"),
            "Ca": log.shift,
            "Nh√† m√°y": log.machine?.process?.factory?.name,
            "C√¥ng ƒëo·∫°n": log.machine?.process?.name,
            "M√°y": log.machine?.name,
            "M·∫∑t h√†ng": log.item?.name,
            "Ch·ªâ s·ªë ƒë·∫ßu": log.startIndex,
            "Ch·ªâ s·ªë cu·ªëi": log.endIndex,
            "S·∫£n l∆∞·ª£ng (kg)": log.finalOutput,
            "Ghi ch√∫": log.note,
            "Ng∆∞·ªùi nh·∫≠p": log.createdBy?.fullName
        }));
        const ws = XLSX.utils.json_to_sheet(dataToExport);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "BaoCao");
        XLSX.writeFile(wb, `SanLuong_${dayjs().format("DDMM_HHmm")}.xlsx`);
    };

    const columns = [
        { title: "Ng√†y", dataIndex: "recordDate", render: (d: string) => dayjs(d).format("DD/MM/YYYY") },
        { title: "Ca", dataIndex: "shift", width: 60, align: 'center' as const, render: (s: number) => <Tag color="blue">{s}</Tag> },
        { title: "C√¥ng ƒëo·∫°n", dataIndex: ["machine", "process", "name"], responsive: ['lg'] as any }, // ·∫®n tr√™n mobile
        { title: "M√°y", dataIndex: ["machine", "name"], width: 100, render: (t: string) => <b>{t}</b> },
        { title: "M·∫∑t h√†ng", dataIndex: ["item", "name"] },
        {
            title: "S·∫£n l∆∞·ª£ng",
            dataIndex: "finalOutput",
            align: 'right' as const,
            render: (n: number) => <b style={{ color: '#389e0d' }}>{n?.toLocaleString()} kg</b>
        },
        { title: "ƒê·∫ßu", dataIndex: "startIndex", align: 'right' as const, width: 90, responsive: ['md'] as any },
        { title: "Cu·ªëi", dataIndex: "endIndex", align: 'right' as const, width: 90, responsive: ['md'] as any },
        { title: "Ng∆∞·ªùi nh·∫≠p", dataIndex: ["createdBy", "fullName"], width: 150, ellipsis: true, responsive: ['lg'] as any },
    ];

    return (
        <div style={{ padding: 20 }}>
            {/* --- PH·∫¶N 1: B·ªò L·ªåC D·ªÆ LI·ªÜU --- */}
            <Card title={<span><FilterOutlined /> B·ªô l·ªçc & T√¨m ki·∫øm</span>} style={{ marginBottom: 20 }} size="small">
                <Row gutter={[16, 16]}>
                    {/* 1. Kho·∫£ng th·ªùi gian */}
                    <Col xs={24} sm={12} md={6}>
                        <div style={{ marginBottom: 4, fontWeight: 500 }}>Kho·∫£ng th·ªùi gian:</div>
                        <RangePicker value={dateRange} onChange={(vals) => setDateRange(vals as any)} style={{ width: '100%' }} format="DD/MM/YYYY" />
                    </Col>

                    {/* 2. Nh√† m√°y */}
                    <Col xs={24} sm={12} md={6}>
                        <div style={{ marginBottom: 4, fontWeight: 500 }}>Nh√† m√°y:</div>
                        <Select
                            mode="multiple" allowClear style={{ width: '100%' }} placeholder="T·∫•t c·∫£"
                            options={factories.map(f => ({ label: f.name, value: f.id }))}
                            onChange={setSelectedFactories} maxTagCount="responsive"
                        />
                    </Col>

                    {/* 3. C√¥ng ƒëo·∫°n */}
                    <Col xs={24} sm={12} md={6}>
                        <div style={{ marginBottom: 4, fontWeight: 500 }}>C√¥ng ƒëo·∫°n:</div>
                        <Select
                            mode="multiple" allowClear style={{ width: '100%' }} placeholder="T·∫•t c·∫£"
                            // L·ªçc c√¥ng ƒëo·∫°n theo nh√† m√°y ƒë√£ ch·ªçn
                            options={processes
                                .filter(p => selectedFactories.length === 0 || selectedFactories.includes(p.factoryId))
                                .map(p => ({ label: p.name, value: p.id }))}
                            onChange={setSelectedProcesses} maxTagCount="responsive"
                        />
                    </Col>

                    {/* 4. M√°y m√≥c */}
                    <Col xs={24} sm={12} md={6}>
                        <div style={{ marginBottom: 4, fontWeight: 500 }}>M√°y m√≥c:</div>
                        <Select
                            mode="multiple" allowClear style={{ width: '100%' }} placeholder="T·∫•t c·∫£"
                            // L·ªçc m√°y theo c√¥ng ƒëo·∫°n ƒë√£ ch·ªçn
                            options={machines
                                .filter(m => selectedProcesses.length === 0 || selectedProcesses.includes(m.processId))
                                .map(m => ({ label: m.name, value: m.id }))}
                            onChange={setSelectedMachines} maxTagCount="responsive"
                        />
                    </Col>

                    {/* 5. Ca l√†m vi·ªác */}
                    <Col xs={12} md={6}>
                        <div style={{ marginBottom: 4, fontWeight: 500 }}>Ca:</div>
                        <Select
                            mode="multiple" style={{ width: '100%' }} placeholder="T·∫•t c·∫£"
                            options={[{ label: 'Ca 1', value: 1 }, { label: 'Ca 2', value: 2 }, { label: 'Ca 3', value: 3 }]}
                            onChange={setSelectedShifts}
                        />
                    </Col>

                    {/* 6. M·∫∑t h√†ng */}
                    <Col xs={12} md={6}>
                        <div style={{ marginBottom: 4, fontWeight: 500 }}>M·∫∑t h√†ng:</div>
                        <Select
                            mode="multiple" allowClear style={{ width: '100%' }} placeholder="T·∫•t c·∫£"
                            options={items.map(i => ({ label: i.name, value: i.id }))}
                            onChange={setSelectedItems} maxTagCount="responsive"
                        />
                    </Col>

                    {/* N√∫t thao t√°c */}
                    <Col xs={24} md={12} style={{ textAlign: 'right', display: 'flex', alignItems: 'flex-end', justifyContent: 'flex-end' }}>
                        <Space>
                            <Button icon={<ReloadOutlined />} onClick={() => setLogs([])}>Reset</Button>
                            <Button type="primary" icon={<SearchOutlined />} onClick={() => handleSearch(1)} loading={loading}>Xem b√°o c√°o</Button>
                            <Button icon={<FileExcelOutlined />} onClick={exportToExcel} disabled={logs.length === 0} style={{ color: 'green', borderColor: 'green' }}>Xu·∫•t Excel</Button>
                        </Space>
                    </Col>
                </Row>
            </Card>

            {/* --- PH·∫¶N 2: DASHBOARD (Bi·ªÉu ƒë·ªì & Th·ªëng k√™) --- */}
            <Row gutter={[16, 16]} style={{ marginBottom: 20 }}>
                {/* Th·∫ª Th·ªëng k√™ T·ªïng */}
                <Col xs={24} md={8}>
                    <Card bordered={false} style={{ height: '100%', background: 'linear-gradient(to right, #f6ffed, #ffffff)' }}>
                        <Statistic
                            title="T·ªîNG S·∫¢N L∆Ø·ª¢NG (To√†n b·ªô k·∫øt qu·∫£ l·ªçc)"
                            value={serverStats.totalOutput}
                            precision={2}
                            suffix="kg"
                            valueStyle={{ color: '#389e0d', fontWeight: 'bold', fontSize: 28 }}
                        />
                        <Divider style={{ margin: '12px 0' }} />
                        <Statistic title="S·ªë d√≤ng d·ªØ li·ªáu t√¨m th·∫•y" value={pagination.total} />
                    </Card>
                </Col>

                {/* Bi·ªÉu ƒë·ªì ph√¢n b·ªë */}
                <Col xs={24} md={16}>
                    <Card size="small" title={<span><BarChartOutlined /> Bi·ªÉu ƒë·ªì S·∫£n l∆∞·ª£ng (Trang hi·ªán t·∫°i)</span>} style={{ height: '100%' }}>
                        {logs.length > 0 ? (
                            <div style={{ width: '100%', height: 200 }}>
                                <ResponsiveContainer>
                                    <BarChart data={chartData} layout="vertical" margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>
                                        <CartesianGrid strokeDasharray="3 3" horizontal={false} />
                                        <XAxis type="number" />
                                        <YAxis type="category" dataKey="name" width={120} tick={{ fontSize: 12 }} />
                                        <RechartsTooltip formatter={(value) => [`${Number(value).toLocaleString()} kg`, 'S·∫£n l∆∞·ª£ng']} />
                                        <Bar dataKey="output" fill="#1890ff" barSize={20} radius={[0, 4, 4, 0]}>
                                            {chartData.map((entry, index) => (
                                                <Cell key={`cell-${index}`} fill={index % 2 === 0 ? '#1890ff' : '#40a9ff'} />
                                            ))}
                                        </Bar>
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        ) : (
                            <div style={{ height: 200, display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#ccc' }}>
                                Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì
                            </div>
                        )}
                    </Card>
                </Col>
            </Row>

            {/* --- PH·∫¶N 3: B·∫¢NG D·ªÆ LI·ªÜU --- */}
            <Card title="Chi ti·∫øt nh·∫≠t k√Ω s·∫£n xu·∫•t" size="small" bodyStyle={{ padding: 0 }}>
                <Table
                    rowKey="id"
                    columns={columns}
                    dataSource={logs}
                    loading={loading}
                    bordered
                    size="middle"
                    // C·∫§U H√åNH PH√ÇN TRANG SERVER SIDE
                    pagination={{
                        current: pagination.current,
                        pageSize: pagination.pageSize,
                        total: pagination.total,
                        showSizeChanger: true,
                        pageSizeOptions: ['20', '50', '100', '200'],
                        showTotal: (total) => `T·ªïng c·ªông ${total} d√≤ng`
                    }}
                    onChange={handleTableChange}
                    scroll={{ x: 1000 }} // Cho ph√©p cu·ªôn ngang tr√™n mobile
                />
            </Card>
        </div>
    );
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\production\history\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\profile\page.tsx
================================================================================
"use client";

import React, { useState } from "react";
import { Card, Form, Input, Button, Tabs, message, Tag, Descriptions } from "antd";
import { UserOutlined, LockOutlined, KeyOutlined, SafetyCertificateOutlined } from "@ant-design/icons";
import { useSession } from "next-auth/react";
import { useRouter } from "next/navigation";

export default function ProfilePage() {
    const { data: session } = useSession();
    const router = useRouter();
    const [loading, setLoading] = useState(false);
    const [form] = Form.useForm();

    // X·ª≠ l√Ω ƒë·ªïi m·∫≠t kh·∫©u
    const handleChangePassword = async (values: any) => {
        setLoading(true);
        try {
            const res = await fetch("/api/profile/change-password", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(values),
            });

            const data = await res.json();

            if (!res.ok) {
                throw new Error(data.error || "C√≥ l·ªói x·∫£y ra");
            }

            message.success("ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
            form.resetFields();

            // T√πy ch·ªçn: ƒêƒÉng xu·∫•t user sau khi ƒë·ªïi pass ƒë·ªÉ b·∫Øt ƒëƒÉng nh·∫≠p l·∫°i
            // import { signOut } from "next-auth/react";
            // signOut(); 

        } catch (error: any) {
            message.error(error.message);
        } finally {
            setLoading(false);
        }
    };

    // Component hi·ªÉn th·ªã th√¥ng tin chung
    const UserInfo = () => (
        <Descriptions bordered column={1}>
            <Descriptions.Item label="H·ªç v√† t√™n">
                <span className="font-bold text-lg">{session?.user?.name || "Ch∆∞a c·∫≠p nh·∫≠t"}</span>
            </Descriptions.Item>
            {/* N·∫øu session b·∫°n c√≥ l∆∞u username/email th√¨ hi·ªÉn th·ªã ·ªü ƒë√¢y */}
            <Descriptions.Item label="Vai tr√≤">
                {session?.user?.role === "ADMIN" ? (
                    <Tag color="red">QU·∫¢N TR·ªä VI√äN</Tag>
                ) : (
                    <Tag color="blue">NH√ÇN VI√äN</Tag>
                )}
            </Descriptions.Item>
            <Descriptions.Item label="Tr·∫°ng th√°i">
                <Tag color="green" icon={<SafetyCertificateOutlined />}>ƒêang ho·∫°t ƒë·ªông</Tag>
            </Descriptions.Item>
        </Descriptions>
    );

    // Component Form ƒë·ªïi m·∫≠t kh·∫©u
    const ChangePasswordForm = () => (
        <Form
            form={form}
            layout="vertical"
            onFinish={handleChangePassword}
            style={{ maxWidth: 500, margin: "0 auto" }}
        >
            <Form.Item
                name="currentPassword"
                label="M·∫≠t kh·∫©u hi·ªán t·∫°i"
                rules={[{ required: true, message: "Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u c≈©" }]}
            >
                <Input.Password prefix={<LockOutlined />} placeholder="Nh·∫≠p m·∫≠t kh·∫©u ƒëang d√πng" />
            </Form.Item>

            <Form.Item
                name="newPassword"
                label="M·∫≠t kh·∫©u m·ªõi"
                rules={[
                    { required: true, message: "Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u m·ªõi" },
                    { min: 6, message: "M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±" }
                ]}
                hasFeedback
            >
                <Input.Password prefix={<KeyOutlined />} placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi" />
            </Form.Item>

            <Form.Item
                name="confirmPassword"
                label="X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi"
                dependencies={['newPassword']}
                hasFeedback
                rules={[
                    { required: true, message: "Vui l√≤ng x√°c nh·∫≠n m·∫≠t kh·∫©u" },
                    ({ getFieldValue }) => ({
                        validator(_, value) {
                            if (!value || getFieldValue('newPassword') === value) {
                                return Promise.resolve();
                            }
                            return Promise.reject(new Error('Hai m·∫≠t kh·∫©u kh√¥ng kh·ªõp!'));
                        },
                    }),
                ]}
            >
                <Input.Password prefix={<KeyOutlined />} placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi" />
            </Form.Item>

            <Form.Item>
                <Button type="primary" htmlType="submit" loading={loading} block icon={<SafetyCertificateOutlined />}>
                    C·∫≠p nh·∫≠t m·∫≠t kh·∫©u
                </Button>
            </Form.Item>
        </Form>
    );

    if (!session) return <div className="p-10 text-center">Vui l√≤ng ƒëƒÉng nh·∫≠p...</div>;

    return (
        <div className="p-6 max-w-4xl mx-auto">
            <Card title={<><UserOutlined /> H·ªì s∆° c√° nh√¢n</>}>
                <Tabs
                    defaultActiveKey="info"
                    items={[
                        {
                            key: "info",
                            label: "Th√¥ng tin chung",
                            children: <UserInfo />,
                        },
                        {
                            key: "security",
                            label: "ƒê·ªïi m·∫≠t kh·∫©u",
                            children: <ChangePasswordForm />,
                        },
                    ]}
                />
            </Card>
        </div>
    );
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\profile\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\providers.tsx
================================================================================
// app/providers.tsx
"use client";

import { SessionProvider } from "next-auth/react";

export function Providers({ children }: { children: React.ReactNode }) {
    return <SessionProvider>{children}</SessionProvider>;
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\providers.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\users\page.tsx
================================================================================
"use client";

import React, { useEffect, useState } from 'react';
import { Table, Button, Modal, Form, Input, Select, Switch, Tag, message, Card, Space, Tooltip } from 'antd';
import { EditOutlined, ReloadOutlined, CheckCircleOutlined, CloseCircleOutlined, UserAddOutlined } from '@ant-design/icons';
import { useSession } from 'next-auth/react';

interface UserType {
    id: number;
    username: string; // <-- ƒê√É S·ª¨A: username
    fullName: string;
    isActive: boolean;
    role: string;
    accessLevel: string;
    process?: { id: number; name: string };
    processId: number | null;
}

export default function UserManagementPage() {
    const { data: session } = useSession();
    const [users, setUsers] = useState<UserType[]>([]);
    const [processes, setProcesses] = useState<any[]>([]);
    const [loading, setLoading] = useState(false);

    // Modal state
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [editingUser, setEditingUser] = useState<UserType | null>(null);
    const [form] = Form.useForm();

    const fetchData = async () => {
        setLoading(true);
        try {
            const [resUsers, resProcesses] = await Promise.all([
                fetch('/api/users'),
                fetch('/api/processes')
            ]);
            if (resUsers.ok && resProcesses.ok) {
                setUsers(await resUsers.json());
                setProcesses(await resProcesses.json());
            } else {
                message.error("Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu");
            }
        } catch (error) {
            message.error("L·ªói k·∫øt n·ªëi");
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        if (session?.user?.role === 'ADMIN') fetchData();
    }, [session]);

    // --- LOGIC L∆ØU (T·∫†O M·ªöI / C·∫¨P NH·∫¨T) ---
    const handleSave = async (values: any) => {
        try {
            const method = editingUser ? 'PUT' : 'POST';

            // N·∫øu S·ª≠a: C·∫ßn ID. N·∫øu T·∫°o: password l·∫•y t·ª´ newPassword
            const payload = editingUser
                ? { ...values, id: editingUser.id }
                : { ...values, password: values.newPassword };

            const res = await fetch('/api/users', {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await res.json();
            if (!res.ok) throw new Error(data.error || "C√≥ l·ªói x·∫£y ra");

            message.success(editingUser ? "ƒê√£ c·∫≠p nh·∫≠t!" : "ƒê√£ t·∫°o t√†i kho·∫£n!");
            setIsModalOpen(false);
            setEditingUser(null);
            fetchData();
        } catch (error: any) {
            message.error(error.message);
        }
    };

    // --- M·ªü Modal T·∫°o M·ªõi ---
    const openCreateModal = () => {
        setEditingUser(null);
        form.resetFields();
        form.setFieldsValue({
            isActive: true,
            role: 'USER',
            accessLevel: 'READ_ONLY'
        });
        setIsModalOpen(true);
    };

    // --- M·ªü Modal S·ª≠a ---
    const openEditModal = (user: UserType) => {
        setEditingUser(user);
        form.resetFields();
        form.setFieldsValue({
            username: user.username, // <-- Bind username
            fullName: user.fullName,
            isActive: user.isActive,
            role: user.role,
            accessLevel: user.accessLevel,
            processId: user.processId,
            newPassword: ''
        });
        setIsModalOpen(true);
    };

    const columns = [
        {
            title: 'Nh√¢n vi√™n',
            render: (_: any, r: UserType) => (
                <div>
                    <div style={{ fontWeight: 'bold' }}>{r.fullName}</div>
                    <div style={{ color: '#888', fontSize: 12 }}>@{r.username}</div>
                </div>
            )
        },
        {
            title: 'B·ªô ph·∫≠n',
            dataIndex: 'process',
            render: (p: any) => p ? <Tag color="blue">{p.name}</Tag> : <Tag>VƒÉn ph√≤ng</Tag>
        },
        {
            title: 'Vai tr√≤',
            dataIndex: 'role',
            render: (role: string) => role === 'ADMIN' ? <Tag color="red">ADMIN</Tag> : <Tag color="green">USER</Tag>
        },
        {
            title: 'Quy·ªÅn h·∫°n',
            dataIndex: 'accessLevel',
            render: (level: string) => {
                const map: any = { 'MANAGER': 'gold', 'OPERATOR': 'cyan', 'READ_ONLY': 'default' };
                return <Tag color={map[level]}>{level}</Tag>
            }
        },
        {
            title: 'Tr·∫°ng th√°i',
            dataIndex: 'isActive',
            align: 'center' as const,
            render: (active: boolean) => active
                ? <CheckCircleOutlined style={{ color: '#52c41a', fontSize: 18 }} />
                : <CloseCircleOutlined style={{ color: 'red', fontSize: 18 }} />
        },
        {
            title: 'H√†nh ƒë·ªông',
            key: 'action',
            render: (_: any, r: UserType) => (
                <Button type="primary" ghost size="small" icon={<EditOutlined />} onClick={() => openEditModal(r)}>
                    S·ª≠a
                </Button>
            )
        }
    ];

    if (session?.user?.role !== 'ADMIN') return <div className="p-10 text-center">Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p</div>;

    return (
        <div style={{ padding: 20 }}>
            <Card
                title="Qu·∫£n tr·ªã Ng∆∞·ªùi d√πng"
                extra={
                    <Space>
                        <Button type="primary" icon={<UserAddOutlined />} onClick={openCreateModal}>
                            Th√™m t√†i kho·∫£n
                        </Button>
                        <Button icon={<ReloadOutlined />} onClick={fetchData}>
                            L√†m m·ªõi
                        </Button>
                    </Space>
                }
            >
                <Table rowKey="id" columns={columns} dataSource={users} loading={loading} bordered pagination={{ pageSize: 8 }} />
            </Card>

            <Modal
                title={editingUser ? `C·∫≠p nh·∫≠t: ${editingUser.fullName}` : "Th√™m nh√¢n vi√™n m·ªõi"}
                open={isModalOpen}
                onCancel={() => setIsModalOpen(false)}
                footer={null}
            >
                <Form form={form} layout="vertical" onFinish={handleSave}>
                    {/* Status Switch */}
                    <Form.Item name="isActive" valuePropName="checked">
                        <Switch checkedChildren="ƒêANG HO·∫†T ƒê·ªòNG" unCheckedChildren="ƒêANG KH√ìA" />
                    </Form.Item>

                    {/* FIELD: USERNAME (ƒê√£ s·ª≠a) */}
                    <Form.Item
                        name="username"
                        label="T√™n ƒëƒÉng nh·∫≠p (Username)"
                        rules={[
                            { required: true, message: 'Vui l√≤ng nh·∫≠p t√™n ƒëƒÉng nh·∫≠p' },
                            { pattern: /^[a-zA-Z0-9_]+$/, message: 'Kh√¥ng ƒë∆∞·ª£c ch·ª©a d·∫•u ho·∫∑c k√Ω t·ª± ƒë·∫∑c bi·ªát' }
                        ]}
                    >
                        {/* Khi s·ª≠a th√¨ kh√¥ng cho ƒë·ªïi username ƒë·ªÉ tr√°nh l·ªói h·ªá th·ªëng */}
                        <Input disabled={!!editingUser} placeholder="vd: nguyenvan_a" />
                    </Form.Item>

                    <Form.Item name="fullName" label="H·ªç t√™n hi·ªÉn th·ªã" rules={[{ required: true }]}>
                        <Input placeholder="Nguy·ªÖn VƒÉn A" />
                    </Form.Item>

                    <div className="grid grid-cols-2 gap-4" style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
                        <Form.Item name="role" label="Vai tr√≤">
                            <Select>
                                <Select.Option value="USER">User</Select.Option>
                                <Select.Option value="ADMIN">Admin</Select.Option>
                            </Select>
                        </Form.Item>
                        <Form.Item name="accessLevel" label="Quy·ªÅn h·∫°n">
                            <Select>
                                <Select.Option value="READ_ONLY">Ch·ªâ xem</Select.Option>
                                <Select.Option value="OPERATOR">Nh·∫≠p li·ªáu</Select.Option>
                                <Select.Option value="MANAGER">Qu·∫£n l√Ω</Select.Option>
                            </Select>
                        </Form.Item>
                    </div>

                    <Form.Item name="processId" label="Thu·ªôc c√¥ng ƒëo·∫°n (N·∫øu c√≥)">
                        <Select allowClear placeholder="Ch·ªçn c√¥ng ƒëo·∫°n...">
                            {processes.map((p: any) => (
                                <Select.Option key={p.id} value={p.id}>{p.name}</Select.Option>
                            ))}
                        </Select>
                    </Form.Item>

                    <Form.Item
                        name="newPassword"
                        label={editingUser ? "ƒê·ªïi m·∫≠t kh·∫©u (B·ªè tr·ªëng n·∫øu kh√¥ng ƒë·ªïi)" : "M·∫≠t kh·∫©u kh·ªüi t·∫°o"}
                        rules={[{ required: !editingUser, message: "B·∫Øt bu·ªôc nh·∫≠p m·∫≠t kh·∫©u khi t·∫°o m·ªõi" }]}
                    >
                        <Input.Password placeholder="******" />
                    </Form.Item>

                    <div style={{ textAlign: 'right' }}>
                        <Space>
                            <Button onClick={() => setIsModalOpen(false)}>H·ªßy</Button>
                            <Button type="primary" htmlType="submit">L∆∞u</Button>
                        </Space>
                    </div>
                </Form>
            </Modal>
        </div>
    );
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\app\users\page.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\auth.config.ts
================================================================================
// src/auth.config.ts
import type { NextAuthConfig } from "next-auth";

export const authConfig = {
  pages: {
    signIn: "/login", // D·∫´n v·ªÅ trang ƒëƒÉng nh·∫≠p c·ªßa b·∫°n
  },
  callbacks: {
    // 1. Logic b·∫£o v·ªá route (Middleware d√πng c√°i n√†y)
    authorized({ auth, request: { nextUrl } }) {
      const isLoggedIn = !!auth?.user;
      const isOnDashboard = nextUrl.pathname.startsWith("/");
      const isOnLogin = nextUrl.pathname.startsWith("/login");

      if (isOnDashboard) {
        if (isLoggedIn) return true;
        return false; // Ch∆∞a login -> ƒê√° v·ªÅ trang login
      } else if (isLoggedIn && isOnLogin) {
        // ƒê√£ login m√† c·ªë v√†o trang login -> ƒê√° v·ªÅ trang ch·ªß
        return Response.redirect(new URL("/", nextUrl));
      }
      return true;
    },
    // 2. T√πy bi·∫øn JWT ƒë·ªÉ l∆∞u th√™m th√¥ng tin
    jwt({ token, user, trigger, session }) {
      if (user) {
        token.role = user.role;
        token.processId = user.processId;
        token.accessLevel = user.accessLevel;
        token.username = user.username;
        token.fullName = user.fullName;
      }
      if (trigger === "update" && session) {
        return { ...token, ...session.user };
      }
      return token;
    },
    // 3. T√πy bi·∫øn Session ƒë·ªÉ Client ƒë·ªçc ƒë∆∞·ª£c
    session({ session, token }) {
      if (session.user && token) {
        session.user.id = token.sub as string;
        session.user.role = token.role as string;
        session.user.processId = token.processId as number | null;
        session.user.accessLevel = token.accessLevel as string;
        session.user.username = token.username as string;
        session.user.fullName = token.fullName as string;
      }
      return session;
    },
  },
  providers: [], // ƒê·ªÉ tr·ªëng, s·∫Ω n·∫°p ·ªü auth.ts
} satisfies NextAuthConfig;


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\auth.config.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\auth.ts
================================================================================
// src/auth.ts
import NextAuth from "next-auth";
import Credentials from "next-auth/providers/credentials";
import { authConfig } from "./auth.config";
import { prisma } from "@/lib/prisma";
import * as bcrypt from "bcryptjs";

export const { handlers, auth, signIn, signOut } = NextAuth({
  ...authConfig,
  providers: [
    Credentials({
      async authorize(credentials) {
        if (!credentials?.username || !credentials?.password) return null;

        const username = String(credentials.username);
        const password = String(credentials.password);

        // T√¨m user trong DB
        const user = await prisma.user.findUnique({
          where: { username },
        });

        if (!user) return null; // Kh√¥ng t√¨m th·∫•y user

        // Ki·ªÉm tra m·∫≠t kh·∫©u
        const isValid = await bcrypt.compare(password, user.password);
        if (!isValid) return null; // Sai m·∫≠t kh·∫©u

        // Ki·ªÉm tra k√≠ch ho·∫°t
        if (!user.isActive) throw new Error("T√†i kho·∫£n ch∆∞a ƒë∆∞·ª£c k√≠ch ho·∫°t");

        // Tr·∫£ v·ªÅ user ƒë·∫ßy ƒë·ªß th√¥ng tin
        // L∆∞u √Ω: Object n√†y s·∫Ω ƒë∆∞·ª£c truy·ªÅn v√†o callback 'jwt' b√™n d∆∞·ªõi
        return {
          id: user.id.toString(),
          name: user.fullName,
          username: user.username,
          role: user.role,
          processId: user.processId,
          accessLevel: user.accessLevel,
          fullName: user.fullName,
        };
      },
    }),
  ],
  // --- PH·∫¶N QUAN TR·ªåNG V·ª™A ƒê∆Ø·ª¢C TH√äM V√ÄO ---
  callbacks: {
    // 1. Chuy·ªÉn d·ªØ li·ªáu t·ª´ authorize (user) sang token
    async jwt({ token, user }) {
      if (user) {
        token.id = user.id;
        token.username = (user as any).username;
        token.role = (user as any).role;
        token.accessLevel = (user as any).accessLevel;
        token.processId = (user as any).processId;
        token.fullName = (user as any).fullName;
      }
      return token;
    },
    // 2. Chuy·ªÉn d·ªØ li·ªáu t·ª´ token sang session (ƒë·ªÉ d√πng ·ªü ph√≠a Client v√† API)
    async session({ session, token }) {
      if (token && session.user) {
        session.user.id = token.id as string;
        // √âp ki·ªÉu 'as any' ƒë·ªÉ tr√°nh l·ªói TypeScript ƒë·ªè do ch∆∞a khai b√°o type m·ªü r·ªông
        (session.user as any).username = token.username;
        (session.user as any).role = token.role;
        (session.user as any).accessLevel = token.accessLevel;
        (session.user as any).processId = token.processId;
        (session.user as any).fullName = token.fullName;
      }
      return session;
    },
  },
});


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\auth.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\components\AdminLayout.tsx
================================================================================
"use client";

import UserDropdown from "@/components/UserDropdown";
import React, { useState, useEffect } from "react";
import { Layout, Menu, Button, theme, Spin } from "antd";
import {
  MenuFoldOutlined,
  MenuUnfoldOutlined,
  DashboardOutlined,
  DatabaseOutlined,
  AppstoreOutlined,
  UserOutlined,
  HistoryOutlined,
  SettingOutlined,
  SafetyCertificateOutlined, // Icon cho qu·∫£n tr·ªã h·ªá th·ªëng
  CloudSyncOutlined,         // Icon cho Backup
  ApartmentOutlined,         // Icon Factory
  BarcodeOutlined,           // Icon Item
  PartitionOutlined,         // Icon Process
  RobotOutlined              // Icon Machine
} from "@ant-design/icons";
import { useRouter, usePathname } from "next/navigation";
import { useSession } from "next-auth/react";

const { Header, Sider, Content, Footer } = Layout;

interface AdminLayoutProps {
  children: React.ReactNode;
}

const AdminLayout: React.FC<AdminLayoutProps> = ({ children }) => {
  const { data: session, status } = useSession();
  const [collapsed, setCollapsed] = useState(false);
  const {
    token: { colorBgContainer, borderRadiusLG },
  } = theme.useToken();

  const router = useRouter();
  const pathname = usePathname();

  // 1. B·∫£o v·ªá route
  useEffect(() => {
    if (status === "unauthenticated" && pathname !== "/login" && pathname !== "/register") {
      router.push("/login");
    }
  }, [status, pathname, router]);

  if (pathname === "/login" || pathname === "/register") {
    return <>{children}</>;
  }

  if (status === "loading") {
    return (
      <div style={{ height: '100vh', display: 'flex', justifyContent: 'center', alignItems: 'center' }}>
        <Spin size="large" />
      </div>
    );
  }

  // 2. C·∫•u h√¨nh Menu C∆° b·∫£n (Ai c≈©ng th·∫•y)
  const baseMenuItems = [
    {
      key: "/",
      icon: <DashboardOutlined />,
      label: "T·ªïng quan (Dashboard)",
    },
    {
      key: "sub1",
      icon: <DatabaseOutlined />,
      label: "Danh m·ª•c d·ªØ li·ªáu",
      children: [
        { key: "/factories", label: "Nh√† m√°y", icon: <ApartmentOutlined /> },
        { key: "/processes", label: "C√¥ng ƒëo·∫°n", icon: <PartitionOutlined /> },
        { key: "/items", label: "M·∫∑t h√†ng", icon: <BarcodeOutlined /> },

      ],
    },
    {
      key: "sub2",
      icon: <AppstoreOutlined />,
      label: "Qu·∫£n l√Ω S·∫£n xu·∫•t",
      children: [
        { key: "/machines", label: "M√°y m√≥c & ƒêi·ªÅu ph·ªëi", icon: <RobotOutlined /> },
        { key: "/production/daily-input", label: "Nh·∫≠p s·∫£n l∆∞·ª£ng" },
        {
          key: "/production/history",
          label: "L·ªãch s·ª≠ & B√°o c√°o",
          icon: <HistoryOutlined />,
        },
      ],
    },
  ];

  // 3. C·∫•u h√¨nh Menu Admin (Ch·ªâ Admin m·ªõi th·∫•y)
  // Gom User v√† Backup v√†o nh√≥m "Qu·∫£n tr·ªã h·ªá th·ªëng"
  if (session?.user?.role === "ADMIN") {
    baseMenuItems.push({
      key: "sub-admin",
      icon: <SafetyCertificateOutlined />,
      label: "Qu·∫£n tr·ªã h·ªá th·ªëng",
      children: [
        {
          key: "/users", // Ho·∫∑c /admin/users n·∫øu b·∫°n ƒë√£ ƒë·ªïi c·∫•u tr√∫c th∆∞ m·ª•c
          icon: <UserOutlined />,
          label: "Qu·∫£n l√Ω T√†i kho·∫£n",
        },
        {
          key: "/admin/backup",
          icon: <CloudSyncOutlined />,
          label: "Sao l∆∞u & Ph·ª•c h·ªìi",
        },
      ],
    } as any);
  }

  // Th√™m m·ª•c C√†i ƒë·∫∑t xu·ªëng cu·ªëi c√πng
  baseMenuItems.push({
    key: "/settings",
    icon: <SettingOutlined />,
    label: "C·∫•u h√¨nh chung",
  } as any);

  return (
    <Layout style={{ minHeight: "100vh" }}>
      {/* SIDER */}
      <Sider trigger={null} collapsible collapsed={collapsed} width={260} theme="dark">
        <div
          style={{
            height: 64,
            margin: 16,
            background: "rgba(255, 255, 255, 0.1)", // Ch·ªânh l·∫°i m√†u n·ªÅn logo cho nh·∫π nh√†ng h∆°n
            border: "1px solid rgba(255, 255, 255, 0.2)",
            display: "flex",
            alignItems: "center",
            justifyContent: "center",
            color: "white",
            fontWeight: "bold",
            fontSize: collapsed ? 16 : 20,
            borderRadius: 8,
            overflow: "hidden",
            whiteSpace: "nowrap",
            transition: "all 0.3s"
          }}
        >
          {collapsed ? "PB" : "PHU BAI ERP"}
        </div>

        <Menu
          theme="dark"
          mode="inline"
          selectedKeys={[pathname]}
          // T·ª± ƒë·ªông m·ªü menu con n·∫øu ƒëang ·ªü trang con t∆∞∆°ng ·ª©ng
          defaultOpenKeys={["sub1", "sub2", "sub-admin"]}
          items={baseMenuItems}
          onClick={({ key }) => {
            if (key.startsWith("/")) {
              router.push(key);
            }
          }}
        />
      </Sider>

      {/* MAIN LAYOUT */}
      <Layout>
        <Header
          style={{
            padding: 0,
            background: colorBgContainer,
            display: "flex",
            justifyContent: "space-between",
            alignItems: "center",
            paddingRight: 24,
            boxShadow: "0 1px 4px rgba(0,21,41,0.08)", // Th√™m b√≥ng ƒë·ªï nh·∫π cho Header t√°ch bi·ªát
            zIndex: 1,
          }}
        >
          <Button
            type="text"
            icon={collapsed ? <MenuUnfoldOutlined /> : <MenuFoldOutlined />}
            onClick={() => setCollapsed(!collapsed)}
            style={{
              fontSize: "16px",
              width: 64,
              height: 64,
            }}
          />

          {/* Component UserDropdown b·∫°n ƒë√£ t√°ch ri√™ng r·∫•t g·ªçn */}
          <UserDropdown />
        </Header>

        <Content
          style={{
            margin: "24px 16px",
            padding: 24,
            minHeight: 280,
            background: colorBgContainer,
            borderRadius: borderRadiusLG,
            overflow: "initial", // ƒê·ªÉ n·ªôi dung d√†i v·∫´n cu·ªôn m∆∞·ª£t
          }}
        >
          {children}
        </Content>

        <Footer style={{ textAlign: "center", color: "#888", background: 'transparent' }}>
          S·ª£i Ph√∫ B√†i ERP ¬©{new Date().getFullYear()} - Developed by Minh Tr√≠
        </Footer>
      </Layout>
    </Layout>
  );
};

export default AdminLayout;

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\components\AdminLayout.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\components\SessionProviderWrapper.tsx
================================================================================
"use client"; // B·∫Øt bu·ªôc ph·∫£i c√≥ d√≤ng n√†y

import { SessionProvider } from "next-auth/react";

export default function SessionProviderWrapper({
  children,
}: {
  children: React.ReactNode;
}) {
  return <SessionProvider>{children}</SessionProvider>;
}


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\components\SessionProviderWrapper.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\components\UserDropdown.tsx
================================================================================
"use client";

import React from "react";
import { Avatar, Dropdown, Space, Typography, Tag, MenuProps, theme } from "antd";
import { LogoutOutlined, DownOutlined, ProfileOutlined, UserOutlined } from "@ant-design/icons";
import { useSession, signOut } from "next-auth/react";
import Link from "next/link";

const { Text } = Typography;

export default function UserDropdown() {
    const { data: session } = useSession();
    const { token } = theme.useToken();

    // N·∫øu ch∆∞a c√≥ session th√¨ kh√¥ng hi·ªÉn th·ªã g√¨
    if (!session?.user) return null;

    // L·∫•y d·ªØ li·ªáu t·ª´ session (Kh·ªõp v·ªõi field 'fullName' c·ªßa b·∫°n)
    // TypeScript c√≥ th·ªÉ b√°o l·ªói ƒë·ªè ·ªü fullName n·∫øu ch∆∞a khai b√°o type, t·∫°m th·ªùi d√πng 'as any' ho·∫∑c check null
    const user = session.user as any;
    const fullName = user.fullName || user.name || "User";
    const role = user.role || "USER";

    // T·∫°o Avatar t·ª´ UI Avatars nh∆∞ code c≈© c·ªßa b·∫°n (nh√¨n ƒë·∫πp h∆°n ch·ªØ c√°i ƒë∆°n thu·∫ßn)
    const avatarUrl = `https://ui-avatars.com/api/?name=${fullName}&background=random&color=fff`;

    const items: MenuProps['items'] = [
        {
            key: 'info',
            label: (
                <div style={{ padding: '4px 0', minWidth: 150 }}>
                    <Text strong>{fullName}</Text>
                    <div style={{ marginTop: 4 }}>
                        {role === "ADMIN" ? <Tag color="red">ADMIN</Tag> : <Tag color="blue">NH√ÇN VI√äN</Tag>}
                    </div>
                </div>
            ),
            disabled: true,
            style: { cursor: 'default', borderBottom: '1px solid #f0f0f0' }
        },
        {
            key: 'profile',
            icon: <ProfileOutlined />,
            label: <Link href="/profile">H·ªì s∆° c√° nh√¢n</Link>,
            style: { marginTop: 4 }
        },
        {
            key: 'logout',
            icon: <LogoutOutlined />,
            label: 'ƒêƒÉng xu·∫•t',
            danger: true,
            onClick: () => signOut({ callbackUrl: "/login" }),
        },
    ];

    return (
        <Dropdown menu={{ items }} trigger={['click']}>
            <Space style={{ cursor: 'pointer', padding: '0 8px', borderRadius: 6, transition: 'background 0.3s' }} className="hover:bg-gray-100">
                <span style={{ marginRight: 4, display: 'flex', flexDirection: 'column', alignItems: 'end', lineHeight: '1.2' }}>
                    <span style={{ fontSize: 14, fontWeight: 500 }}>{fullName}</span>
                </span>

                <Avatar
                    src={avatarUrl}
                    icon={<UserOutlined />}
                    style={{ border: `1px solid ${token.colorBorder}` }}
                />
            </Space>
        </Dropdown>
    );
}

--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\components\UserDropdown.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\lib\AntdRegistry.tsx
================================================================================
// src/lib/AntdRegistry.tsx
"use client";

import React from "react";
import { createCache, extractStyle, StyleProvider } from "@ant-design/cssinjs";
import type Entity from "@ant-design/cssinjs/es/Cache";
import { useServerInsertedHTML } from "next/navigation";

const StyledComponentsRegistry = ({ children }: React.PropsWithChildren) => {
  const cache = React.useMemo<Entity>(() => createCache(), []);
  useServerInsertedHTML(() => (
    <style
      id="antd"
      dangerouslySetInnerHTML={{ __html: extractStyle(cache, true) }}
    />
  ));
  return <StyleProvider cache={cache}>{children}</StyleProvider>;
};

export default StyledComponentsRegistry;


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\lib\AntdRegistry.tsx ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\lib\prisma.ts
================================================================================
// lib/prisma.ts

// T√°c d·ª•ng: ƒê·∫£m b·∫£o ch·ªâ c√≥ DUY NH·∫§T 1 k·∫øt n·ªëi ƒë·∫øn Database ƒë∆∞·ª£c t·∫°o ra trong su·ªët qu√° tr√¨nh ch·∫°y app.
import { PrismaClient } from "@prisma/client";

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined;
};

export const prisma = globalForPrisma.prisma ?? new PrismaClient();

if (process.env.NODE_ENV !== "production") globalForPrisma.prisma = prisma;


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\lib\prisma.ts ---


================================================================================
FILE START: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\middleware.ts
================================================================================
// src/middleware.ts
import NextAuth from "next-auth";
import { authConfig } from "./auth.config";

export default NextAuth(authConfig).auth;

export const config = {
  // Ch·∫∑n t·∫•t c·∫£, tr·ª´ c√°c file tƒ©nh v√† API
  matcher: ["/((?!api|_next/static|_next/image|favicon.ico).*)"],
};


--- FILE END: D:\DU-AN-PHAN-MEM\PHUBAI-PRODUCTS\phubai-products\src\middleware.ts ---
