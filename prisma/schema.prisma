// File: schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // Hoặc "mysql", "sqlserver" tùy bạn chọn
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. QUẢN LÝ CẤU TRÚC NHÀ MÁY (Hierarchy)
// ==========================================

model Factory {
  id        Int       @id @default(autoincrement())
  name      String    // Tên nhà máy (NM1, NM2...)
  note      String?   // Ghi chú

  processes Process[] // 1 Nhà máy có nhiều Công đoạn

  @@map("factories")
}

// ==========================================
// 2. CÔNG ĐOẠN
// ==========================================
model Process {
  id        Int       @id @default(autoincrement())
  name      String    // Tên công đoạn (bông chải, ghép thô...)
  
  factoryId Int
  factory   Factory   @relation(fields: [factoryId], references: [id])

  machines  Machine[] // 1 Công đoạn quản lý nhiều Máy
  users     User[]    // Phân quyền: User nào thuộc công đoạn nào

  @@map("processes")
}

// ==========================================
// 2. DANH MỤC MẶT HÀNG (Items)
// ==========================================

model Item {
  id           Int     @id @default(autoincrement())
  
  // Các trường thông tin cơ bản
  name         String  @unique // Tên đầy đủ (Không được trùng)
  code         String? // Mã viết tắt (nếu cần sau này, tạm để optional)
  
  // Các thông số kỹ thuật (Optional - Không bắt buộc)
  ne           Int?    // Chi số (Số nguyên 3 chữ số)
  composition  String? // Thành phần
  twist        Int?    // Độ săn (Số nguyên)
  weavingStyle String? // Kiểu dệt
  material     String? // Nguyên liệu
  
  // Quan hệ (Giữ nguyên logic cũ)
  runningOnMachines Machine[]       // Đang chạy trên máy nào?
  productionLogs    ProductionLog[] // Lịch sử sản xuất

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("items")
}

// ==========================================
// 3. DANH MỤC MÁY MÓC (Machines) - Cấu hình
// ==========================================

model Machine {
  id          Int      @id @default(autoincrement())
  name        String   @unique // Tên máy (Máy 01, Máy 02...)
  isActive    Boolean  @default(true) // True: Đang dùng, False: Đã thanh lý (Thay máy mới)

  // --- Phân cấp ---
  processId   Int
  process     Process  @relation(fields: [processId], references: [id])

  // --- Cấu hình tính toán (Quan trọng) ---
  // 1: Nhập thẳng kg
  // 2: (Cuối - Đầu)
  // 3: (Cuối - Đầu) * Số cọc / (Chi số * K)
  // 4: (Cuối - Đầu) / Chi số
  formulaType Int      @default(1) 

  spindleCount Int?    // Số cọc (Chỉ dùng cho FormulaType = 3, máy khác để Null)

  // --- Trạng thái hiện tại ---
  currentItemId Int?   // Máy đang chạy hàng nào? (Dùng để gợi ý khi nhập liệu)
  currentItem   Item?  @relation(fields: [currentItemId], references: [id])

  // 2. Chi số đang chạy là bao nhiêu?
  // Dành cho máy loại 3, 4. 
  // Giá trị này sẽ tự động nhảy vào ô nhập liệu để công nhân đỡ phải gõ.
  currentNE     Float?

  maintenanceTasks MaintenanceTask[]

  // --- Dữ liệu lịch sử ---
  productionLogs ProductionLog[]

  @@map("machines")
}

// ==========================================
// 4. NHẬT KÝ SẢN LƯỢNG (Dữ liệu hàng ngày)
// ==========================================

model ProductionLog {
  id          Int      @id @default(autoincrement())
  
  // 1. Thông tin Máy & Thời gian
  machineId   Int
  recordDate  DateTime @db.Date // Chỉ lưu ngày
  shift       Int      // 1, 2, 3
  
  // 2. Thông tin Mặt hàng (Sửa lỗi quan hệ với Item)
  itemId      Int
  item        Item     @relation(fields: [itemId], references: [id]) 
  
  // 3. Chỉ số & Sản lượng
  startIndex  Float?   @default(0) // <--- Cột mới thêm
  endIndex    Float?
  inputNE     Float?   
  finalOutput Float    
  
  note        String?

  // 4. Quan hệ với User (Sửa lỗi createdLogs trong User)
  // Thêm dòng này để Prisma biết ai là người tạo bản ghi
  createdById Int?     // Có thể để null nếu chưa bắt buộc
  createdBy   User?    @relation(fields: [createdById], references: [id])
  
  // 5. Quan hệ với Máy
  machine     Machine  @relation(fields: [machineId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // THÊM ĐOẠN NÀY VÀO CUỐI MODEL:
  // 1. Index cho việc lọc theo khoảng thời gian (quan trọng nhất)
  @@index([recordDate])
  
  // 2. Index composite: Khi lọc kết hợp Ngày + Máy + Ca (Performance cực cao)
  @@index([recordDate, machineId])
  @@index([machineId, shift])
  @@index([itemId])

  // Ràng buộc duy nhất: 1 Máy + 1 Ngày + 1 Ca chỉ có 1 bản ghi
  @@unique([machineId, recordDate, shift])
  @@map("production_logs")
}

// ==========================================
// 5. NGƯỜI DÙNG (Quản lý quyền hạn)
// ==========================================

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String   // Lưu hash (đã mã hóa)
  fullName  String
  
  // --- PHÂN QUYỀN ---
  role        String   @default("USER") // "ADMIN" hoặc "USER"
  accessLevel String   @default("READ_ONLY") // "READ_ONLY", "OPERATOR", "MANAGER"
  
  // --- TRẠNG THÁI ---
  isActive    Boolean  @default(false)  // false: Chờ duyệt, true: Được dùng

  // --- PHẠM VI CÔNG VIỆC ---
  processId   Int?     // User thuộc công đoạn nào?
  process     Process? @relation(fields: [processId], references: [id])

  createdLogs ProductionLog[] // Quan hệ: Ai nhập dòng này?
  createdAt   DateTime @default(now())

  @@map("users")
}

// Bảng Danh mục Hạng mục bảo dưỡng (Maintenance Task)
// Lưu trữ các cấu hình định kỳ cho từng máy
model MaintenanceTask {
  id                String   @id @default(cuid())
  
  // Điều chỉnh machineId thành kiểu Int để khớp với Machine.id
  machineId         Int      
  
  taskName          String   
  description       String?  
  intervalMonths    Float    
  lastPerformedDate DateTime? 
  nextDueDate       DateTime  
  leadTimeDays      Int      @default(30) 
  emailNotify       Boolean  @default(true)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Thiết lập mối quan hệ chính thức với bảng Machine
  // Lưu ý: Tên field là 'machine', khớp với lệnh include trong API
  machine           Machine  @relation(fields: [machineId], references: [id])
  
  history           MaintenanceHistory[]

  @@index([machineId])
  @@index([nextDueDate])
  @@map("maintenance_tasks")
}

// Cần bổ sung thêm quan hệ vào bảng Machine để Prisma nhận diện
// (Thêm dòng này vào bên trong model Machine của bạn)
// model Machine {
//   ...
//   maintenanceTasks MaintenanceTask[]
// }

// Bảng Nhật ký bảo dưỡng (Maintenance History)
// Lưu vết mỗi lần thực hiện xong
model MaintenanceHistory {
  id                String   @id @default(cuid())
  taskId            String
  performedDate     DateTime @default(now()) // Ngày thực hiện thực tế
  performedBy       String?  // Tên công nhân/kỹ thuật viên
  notes             String?  // Ghi chú tình trạng lúc đó
  cost              Float?   @default(0)
  
  // Quan hệ
  task              MaintenanceTask @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([performedDate])
}